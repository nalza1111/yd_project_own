<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/default_layout}">
<head>
<meta charset="UTF-8">
<title>Insert title here</title>
<script src="https://code.jquery.com/jquery-3.5.1.js"></script>
<!-- 소켓js cdn -->
<script
	src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
<link rel="stylesheet"
	href="https://cdnjs.cloudflare.com/ajax/libs/meyer-reset/2.0/reset.min.css" />
<script src="https://code.jquery.com/jquery-1.8.3.min.js"
	integrity="sha256-YcbK69I5IXQftf/mYD8WY0/KmEDCv1asggHpJk1trM8="
	crossorigin="anonymous"></script>

<style>
.chat_wrap {
	border: 1px solid #999;
	width: 300px;
	padding: 5px;
	font-size: 13px;
	color: #333
}

.chat_wrap .inner {
	background-color: #acc2d2;
	border-radius: 5px;
	padding: 10px;
	overflow-y: scroll;
	height: 400px;
}

.chat_wrap .item {
	margin-top: 15px
}

.chat_wrap .item:first-child {
	margin-top: 0px
}

.chat_wrap .item .box {
	display: inline-block;
	max-width: 180px;
	position: relative
}

.chat_wrap .item .box::before {
	content: "";
	position: absolute;
	left: -8px;
	top: 9px;
	border-top: 0px solid transparent;
	border-bottom: 8px solid transparent;
	border-right: 8px solid #fff;
}

.chat_wrap .item .box .msg {
	background: #fff;
	border-radius: 10px;
	padding: 8px;
	text-align: left;
	word-break: break-word;
}

.chat_wrap .item .box .time {
	font-size: 11px;
	color: #999;
	position: absolute;
	right: -75px;
	bottom: 5px;
	width: 70px
}

.chat_wrap .item.mymsg {
	text-align: right
}

.chat_wrap .item.mymsg .box::before {
	left: auto;
	right: -8px;
	border-left: 8px solid #fee600;
	border-right: 0;
}

.chat_wrap .item.mymsg .box .msg {
	background: #fee600
}

.chat_wrap .item.mymsg .box .time {
	right: auto;
	left: -75px
}

.chat_wrap .item .box {
	transition: all .3s ease-out;
	margin: 0 0 0 20px;
	opacity: 0
}

.chat_wrap .item.mymsg .box {
	transition: all .3s ease-out;
	margin: 0 20px 0 0;
}

.chat_wrap .item.on .box {
	margin: 0;
	opacity: 1;
}

input[type="text"] {
	border: 0;
	width: 100%;
	background: #ddd;
	border-radius: 5px;
	height: 30px;
	padding-left: 5px;
	box-sizing: border-box;
	margin-top: 5px
}

input[type="text"]::placeholder {
	color: #999
}
</style>
<script>
let id = "미주";
	$(function() {
		$("input[type='text']").keypress(
				function(e) {
					if (e.keyCode == 13 && $(this).val().length) {
						var _val = $(this).val();
						var _class = $(this).attr("class");
						$(this).val('');
						var _tar = $(".chat_wrap .inner")
								.append(
										'<div class="item '+_class+'"><div class="box"><p class="msg">'
												+ _val
												+ '</p><span class="time">'
												+ currentTime()
												+ '</span></div></div>');

						var lastItem = $(".chat_wrap .inner")
								.find(".item:last");
						setTimeout(function() {
							lastItem.addClass("on");
						}, 10);

						var position = lastItem.position().top
								+ $(".chat_wrap .inner").scrollTop();
						console.log(position);

						$(".chat_wrap .inner").stop().animate({
							scrollTop : position
						}, 500);
					}
				
	/* ====================== 채팅창에 내용넣고 엔터치면 시작하는 함수 ======================*/
				sendBroadcast({
		                'id': id,
		                'content': _val
				});

	});

	var currentTime = function() {
		var date = new Date();
		var hh = date.getHours();
		var mm = date.getMinutes();
		var apm = hh > 12 ? "오후" : "오전";
		var ct = apm + " " + hh + ":" + mm + "";
		return ct;
	}
	/* ====================== 채팅 웹소켓 함수 시작 ======================*/
	$(document).ready(socketConnect());

	function socketConnect() {
		let socket = new SockJS('/chat');
		let url = '/topic/' + id + '/queue/messages';
		// webSocket 대신 SockJS을 사용하므로 Stomp.client()가 아닌 Stomp.over()를 사용함

		//connect(header, connectCallback(==연결에 성공하면 실행되는 메서드))
		stompClient.connect({}, function() {
			// url: 채팅방 참여자들에게 공유되는 경로
			/* callback(function()): 클라이언트가 서버(Controller broker)로부터 
			 * 메시지를 수신했을 때(== STOMP send()가 실행되었을 때) 실행 
			 */
			stompClient.subscribe(url, function(output) { // JSP <body>에 append할 메시지 contents
				showBroadcastMessage(createTextNode(JSON.parse(output.body)));
			});
		},
		function(err) { // connect() 에러 발생 시 실행
			alert('error' + err);
		});
	} // socketConnect() end.
	
	// WebSocket broker 경로로 JSON 타입 메시지데이터를 전송함
	function sendBroadcast(json) {
            stompClient.send("/app/chat", {}, JSON.stringify(json));
        }
	
</script>
</head>
<div layout:fragment="content">
	<body>

		<div class="chat_wrap">
			<div class="inner"></div>

			<input type="text" class="mymsg" placeholder="나의 내용 입력">
		</div>
	</body>
</div>
</html>