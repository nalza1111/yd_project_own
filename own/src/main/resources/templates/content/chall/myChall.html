<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" lang="ko">
<head>
<!-- jquery -->
<script
	src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<meta content="Free HTML Templates" name="keywords" />
<!-- Favicon -->
<link href="/css/chall/img/favicon.ico" rel="icon" />
<!-- Google Web Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com" />
<link
	href="https://fonts.googleapis.com/css2?family=Handlee&family=Nunito&display=swap"
	rel="stylesheet" />
<!-- Font Awesome -->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
	rel="stylesheet" />
<!-- Flaticon Font -->
<link href="/css/chall/lib/flaticon/font/flaticon.css" rel="stylesheet" />
<!-- Libraries Stylesheet -->
<link href="/css/chall/lib/owlcarousel/assets/owl.carousel.min.css"
	rel="stylesheet" />
<link href="/css/chall/lib/lightbox/css/lightbox.min.css"
	rel="stylesheet" />
<!-- Customized Bootstrap Stylesheet -->
<link href="/css/chall/css/style.css" rel="stylesheet" />
<!-- JavaScript Libraries -->
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script src="/css/chall/lib/easing/easing.min.js"></script>
<script src="/css/chall/lib/owlcarousel/owl.carousel.min.js"></script>
<script src="/css/chall/lib/isotope/isotope.pkgd.min.js"></script>
<script src="/css/chall/lib/lightbox/js/lightbox.min.js"></script>
<!-- Contact Javascript File -->
<script src="/css/chall/mail/jqBootstrapValidation.min.js"></script>
<script src="/css/chall/mail/contact.js"></script>
<!-- Template Javascript -->
<script src="/css/chall/js/main.js"></script>
<!-- google chart -->
<script
	src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
<meta charset="utf-8">
<title>도전_마이페이지_내 도전</title>
</head>
<body>

	<!-- Navbar Start -->
	<div class="container-fluid bg-light position-relative shadow">
		<nav
			class="navbar navbar-expand-lg bg-light navbar-light py-3 py-lg-0 px-0 px-lg-5">
			<a href="" class="navbar-brand font-weight-bold text-secondary"
				style="font-size: 50px"> <i class="flaticon-043-teddy-bear"></i>
				<span class="text-primary">OWN_Challenges</span>
			</a>
			<button type="button" class="navbar-toggler" data-toggle="collapse"
				data-target="#navbarCollapse">
				<span class="navbar-toggler-icon"></span>
			</button>
			<div class="collapse navbar-collapse justify-content-between"
				id="navbarCollapse">
				<div class="navbar-nav font-weight-bold mx-auto py-0">
					<a href="index.html" class="nav-item nav-link">Home</a> <a
						href="about.html" class="nav-item nav-link">About</a> <a
						href="class.html" class="nav-item nav-link">Classes</a> <a
						href="team.html" class="nav-item nav-link">Teachers</a> <a
						href="gallery.html" class="nav-item nav-link">Gallery</a>
					<div class="nav-item dropdown">
						<a href="#" class="nav-link dropdown-toggle"
							data-toggle="dropdown">Pages</a>
						<div class="dropdown-menu rounded-0 m-0">
							<a href="blog.html" class="dropdown-item">Blog Grid</a> <a
								href="single.html" class="dropdown-item">Blog Detail</a>
						</div>
					</div>
					<a href="contact.html" class="nav-item nav-link active">Contact</a>
				</div>
				<a href="" class="btn btn-primary px-4">Join Class</a>
			</div>
		</nav>
	</div>
	<!-- Navbar End -->

	<input id="userId" name="userId" type="hidden" th:if="${session.loginUser}" th:value="${session.loginUser.userId}" />

	<!-- Blog Start -->
	<div class="container-fluid pt-5" id="myPageChallDiv">
		<div class="container">
			<div class="text-center pb-2">
				<p class="section-title px-5">
					<span class="px-2">My Page</span>
				</p>
				<h1 class="mb-4">나의 도전</h1>
			</div>

			<!-- 나의도전 한줄 메뉴바 -->
			<div class="row" style="margin: auto;">
				<div class="col-12 text-left mb-2" >
					<ul class="list-inline mb-4" id="menu-filters" style="text-align: center;">
						<li class="btn btn-outline-primary m-1 active" id="myChall" val="1"> 내가 참여 중인 도전</li>
						<li class="btn btn-outline-primary m-1" id="likeChall" val="1">내가 북마크한 도전</li>
						<li class="btn btn-outline-primary m-1" id="leaderChall" val="1">내가 만든</li>	
					</ul>
				</div>
			</div>
			<!-- 나의도전 한줄 메뉴바 끝 -->

				<!-- 여기부터  6개 한블럭? -->
			<div class="row pb-3" id="challRow">
			
				<th:block th:each="my: ${myChall}">
					<div class="col-lg-4 mb-4" >
						<div class="card border-0 shadow-sm mb-2">
							<img class="card-img-top mb-2"
								th:src="|/imgView/${my.firstImage}|" alt=""
								style="height:240px; object-fit: cover" />
							<div class="card-body bg-light text-center p-4">
								<input type="hidden" th:value="${my.challNo}" />
								<h4 class="" th:text="${my.challTitle}"></h4>
								<div class="d-flex justify-content-center mb-3">
									<small class="mr-3">[[${#dates.format(my.challStartdate, 'M/d')}]]시작</small>
								    <small class="mr-3">[[${my.challDuration}]]주 동안</small>
								    <small class="mr-3">주 [[${my.challFreq}]]회</small>
								    <small class="mr-3">[[${my.nowMem}]] 참여 중</small>
								</div>
								<a
									th:href="@{/own/chall/detailChall(challNo = ${#strings.substringAfter(my.challNo, 'CHA_')})}"
									class="btn btn-primary px-4 mx-auto my-2">상세보기</a>
							</div>
						</div>
					</div>
				</th:block>
			</div>
		</div>	
	<!-- 도전 6개 끝 -->

		<!-- 페이징버튼 넣기 -->
		<nav class="blog-pagination justify-content-center d-flex"
			id="myChallPage">
			<!--================ 이전  =================-->
			<ul class="pagination">
				<li class="page-item" th:if="${paging.startPage > 1}"><a
					class="page-link" aria-label="Previous"
					th:value="${paging.startPage-1}"> <span aria-hidden="true"><span
							class="lnr lnr-chevron-left pagePort"></span></span></a></li>
				<!--================ 페이지 이동 1_2_3_4_5  =================-->
				<th:block
					th:each="pag:${#numbers.sequence(paging.startPage,paging.endPage)}">
					<li class="page-item" th:if="${pag != paging.page}"><a
						class="page-link pagePort" th:value="${pag}"
						th:text="${#numbers.formatInteger(pag,2)}"></a></li>
					<li class="page-item active" th:if="${pag==paging.page}"><a
						class="page-link" th:text="${#numbers.formatInteger(pag,2)}"></a>
					</li>
				</th:block>
				<!--================ 페이지 이동 1_2_3_4_5 끝 =================-->
				<!--================ 이후  =================-->
				<li class="page-item" th:if="${paging.endPage<paging.lastPage}">
					<a class="page-link pagePort" aria-label="Next"
					th:value="${paging.endPage+1}"> <span aria-hidden="true"><span
							class="lnr lnr-chevron-right"></span></span></a>
				</li>
			</ul>
		</nav>
		<nav class="blog-pagination justify-content-center d-flex"
			id="myLikePage"></nav>
		
	</div>
	<!-- Blog End -->

<script>
	//토큰있어야 post가능~!
    /*<![CDATA[*/
    var header = '[[${_csrf.headerName}]]';
     var token = '[[${_csrf.token}]]';
       console.log(header);
       console.log(token);
     /*]]>*/
	//
	
	//----자주쓰는애들 정의 지금 1. 로그인한 회원아이디
	let userIdInfo = $('#userId').val();


	//-------------------------//메뉴 클릭 색깔 변경 이벤트 --------------------------------------

    $('#menu-filters li').click(function(){
    	$('#menu-filters li').removeClass('active');
    	$(this).addClass('active');
    })

	//처음 보여주는 참여중인 도전 페이징 버튼 -  
	$('#myPageChallDiv').on('click', '.pagePort', function(){
		console.log("왜안되노")
		//페이지번호 + 밴드식별번호
		let page = $(this).attr('value');
		console.log($(this).attr('value'));
		$.ajax({
		url: '/own/chall/myPageChallAjax',
		method: 'get',
		data: { page:page,
				pageUnit:6,
				pageSize:3,
				userId: userIdInfo},
		}).then(result => {
		console.log(result);
			//형태만들기
			//모델으로 가져온 도전 지우기.
			let Chall = $('#ChallRow')
			$('#challRow').empty();
			result.forEach( cha => {
				makeChallDiv(cha);
			})
		//페이징 버튼
		let pagingName = 'myChallPage';
		$('#myPageChallDiv nav').remove();
		makePaging(result, pagingName);
		})
       });

	   //-----------------------------------내가 좋아요한 도전--------------------------------------

	   //좋아요한 도전
	   $('#likeChall').on('click', function(){

		$.ajax({
          url: '/own/chall/myLikeChallAjax',
          method: 'get',
		  data: {page:1,
				 pageUnit:1,
			     pageSize:5,
				 userId: userIdInfo},
          success: function(result){
			let Chall = $('#ChallRow')
			$('#challRow').empty();
            result.forEach( vld => {
              makeChallDiv(vld);
            });
			let pagingName = 'leaderPageBtn';
			$('#myPageChallDiv nav').remove();
			makePaging(result, pagingName);
          },
          error: function(err){
            console.log(err);
          }
        })
	   })

		/* 아작스 페이징 버튼 */
		function makePaging(result, pagingName){
			//마지막 요소 제거. nav제거..
			let navTag = $(`<nav class="blog-pagination justify-content-center d-flex" id=${pagingName} />`);
			//버튼 다시초기화..비우기
			// $(`#${pagingName}`).empty();
		    let pagingM = result[0].paging;
		    //시작 버튼
		    console.log(result[0]); //첫번째? 가져오기..?
		    let startpageTag = $('<ul class="pagination" />');
		    // $(`#${pagingName}`).append(startpageTag);
			navTag.append(startpageTag);
		    //이전 버튼만들기
			if(pagingM.startPage>1){
               let pageBeforTag = `<li class="page-item">
                                 <a class="page-link pagePort" aria-label="Previous" value=${pagingM.startPage-1}>
                                 <span aria-hidden="true"> <-
                         <span class="lnr lnr-chevron-left pagePort"></span></span></a>
                                 </li>`
                    startpageTag.append(pageBeforTag); 
                }                   
			//페이지목록..
		    for(let pg = pagingM.startPage; pg<=pagingM.endPage; pg++){
		            if(pg != pagingM.page){
		            	let pageTag = `<li class="page-item">
		                               <a class="page-link pagePort" value=${pg}>${pg}</a>
		                               </li>`
		                startpageTag.append(pageTag);
		            } else if(pg == pagingM.page ){
						 let pageTag =  `<li class="page-item active">
							<a class="page-link" >${pg}</a>
							</li>`
							startpageTag.append(pageTag);
					}
			}               
			//이후 버튼만들기
			if(pagingM.endPage<pagingM.lastPage){
						let pageAfterTag =`<li class="page-item">
							<a class="page-link pagePort" aria-label="Next" value=${pagingM.endPage+1}>
								<span aria-hidden="true"> ->
								<span class="lnr lnr-chevron-right"></span></span></a>
								</li>`
								startpageTag.append(pageAfterTag);
			}
			$('#myPageChallDiv').append(navTag);
		}


	//챌린지 폼 만들기
	function makeChallDiv(cha){
		console.log(cha.challLeader);
		let challNo = cha.challNo.substr(4);
		console.log(challNo);
		let div1 = $('<div />').addClass("col-lg-4 mb-4");
		let div2 = $('<div />').addClass("card border-0 shadow-sm mb-2");
		let hiddenInput = $('<input />').attr('type', 'hidden').val(cha.challNo);
		let img2_1 = $('<img />').addClass("card-img-top mb-2").attr('src', '/imgView/'+ cha.firstImage).attr('style', 'height:230px; object-fit: cover')
		let div2_2 = $('<div />').addClass("card-body bg-light text-center p-4")
		let h4_3 = $('<h4 />').addClass("card-title"). text(cha.challTitle);
		let div_3 = $('<div />').addClass("d-flex justify-content-center mb-3").append(($('<small />').addClass("mr-3").text(cha.challStartdate + '시작')),
																					   ($('<small />').addClass("mr-3").text(cha.challDuration + '주 동안')),
																					   ($('<small />').addClass("mr-3").text('주 '+cha.challFreq + '회')),
																					   ($('<small />').addClass("mr-3").text(cha.nowMem + '명 참여중'))
																					  );
		let a_3 = $('<a />').addClass("btn btn-primary px-4 mx-auto my-2").attr('href', 'detailChall?challNo=' + challNo); 
		div1.append(div2.append(hiddenInput, img2_1, div2_2.append(h4_3, div_3, a_3)));
		$('#challRow').append(div1);
	}
	
</script>
</body>
</html>