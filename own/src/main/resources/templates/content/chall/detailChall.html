<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" 
	layout:decorate="~{layout/default_layout}"
	lang="ko">

<head>
	<!-- jquery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
	<meta content="width=device-width, initial-scale=1.0" name="viewport" />
	<meta content="Free HTML Templates" name="keywords" />
	<!-- Favicon -->
	<link href="/css/chall/img/favicon.ico" rel="icon" />
	<!-- Google Web Fonts -->
	<link rel="preconnect" href="https://fonts.gstatic.com" />
	<link href="https://fonts.googleapis.com/css2?family=Handlee&family=Nunito&display=swap" rel="stylesheet" />
	<!-- Font Awesome -->
	<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet" />
	<!-- Flaticon Font -->
	<link href="/css/chall/lib/flaticon/font/flaticon.css" rel="stylesheet" />
	<!-- Libraries Stylesheet -->
	<link href="/css/chall/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />
	<link href="/css/chall/lib/lightbox/css/lightbox.min.css" rel="stylesheet" />
	<!-- Customized Bootstrap Stylesheet -->
	<link href="/css/chall/css/style.css" rel="stylesheet" />
	<!-- JavaScript Libraries -->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
	<script src="/css/chall/lib/easing/easing.min.js"></script>
	<script src="/css/chall/lib/owlcarousel/owl.carousel.min.js"></script>
	<script src="/css/chall/lib/isotope/isotope.pkgd.min.js"></script>
	<script src="/css/chall/lib/lightbox/js/lightbox.min.js"></script>
	<!-- Contact Javascript File -->
	<script src="/css/chall/mail/jqBootstrapValidation.min.js"></script>
	<script src="/css/chall/mail/contact.js"></script>
	<!-- Template Javascript -->
	<script src="/css/chall/js/main.js"></script>

	<!-- google chart -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
	<meta charset="utf-8">
	<style>
		.card {
			position: relative;
			flex: 1 1 100%;
			margin: 10px 0;
			padding: 20px;
			background: #fff;
		}

		.card__img {
			margin: -20px -20px 0;
		}

		.card__img img {
			max-width: 100%;
			height: auto;
			border: 0;
			vertical-align: middle;
			box-sizing: border-box;
		}

		.card__desc {
			margin-top: 20px;
		}

		.card__one {
			transition: transform 0.5s;
		}

		.card__one::after {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			transition: opacity 2s cubic-bezier(0.165, 0.84, 0.44, 1);
			box-shadow: 0 8px 17px 0 rgba(0, 0, 0, .2), 0 6px 20px 0 rgba(0, 0, 0, .15);
			content: '';
			opacity: 0;
			z-index: -1;
		}

		.card__one:hover,
		.card__one:focus {
			transform: scale3d(1.006, 1.006, 1);
		}

		.card__one:hover::after,
		.card__one:focus::after {
			opacity: 1;
		}

		.modal {
			display: none;
			/* Hidden by default */
			position: fixed;
			/* Stay in place */
			z-index: 1;
			/* Sit on top */
			left: 0;
			top: 0;
			width: 100%;
			/* Full width */
			height: 100%;
			/* Full height */
			overflow: auto;
			/* Enable scroll if needed */
			background-color: rgb(0, 0, 0);
			/* Fallback color */
			background-color: rgba(0, 0, 0, 0.4);
			/* Black w/ opacity */
		}

		/* Modal Content/Box */
		.modal-content {
			background-color: #fefefe;
			margin: 15% auto;
			/* 15% from the top and centered */
			padding: 20px;
			border: 1px solid #888;
			width: 50%;
			/* Could be more or less, depending on screen size */
		}

		/* The Close Button */
		.close {
			color: #aaa;
			float: right;
			font-size: 28px;
			font-weight: bold;
		}

		.close:hover,
		.close:focus {
			color: black;
			text-decoration: none;
			cursor: pointer;
		}
	</style>
	<title>OWN _ 도전 상세</title>
</head>

<div layout:fragment="content">
<body>
	<!-- Header Start -->
	<div class="container-fluid bg-primary" style="padding: 0; ">
		<div class="d-flex flex-column align-items-center justify-content-center" style="min-height: 400px; background-image: url(/img/chall/category/swim_main.jpg);
			background-size: contain">
			<!-- 	<img src="/img/chall/category/swim_main.jpg" style=" object-fit: cover"/> -->
			<div class="d-inline-flex text-white">
				<p class="m-0">
					<a class="text-white" href="">Home</a></p>
				<p class="m-0 px-2">/</p>
				<p class="m-0">Contact Us</p>
			</div>
		</div>
	</div>

	<!-- Detail Start -->
	<div class="container py-5">
		<div class="row pt-5">
			<div class="col-lg-8"> <!-- 상세보기 왼쪽 내용부분! -->
				<div style="width: 700px"> <!-- 도전 대표사진 및 간단 설명 div -->
					<div class="d-flex flex-column text-left mb-3">
						<p class="section-title pr-5">
							<span class="pr-2">About Challenges</span>
						</p>
						<h1 class="mb-3" th:text="${detailChall.challTitle}"></h1>
						<div class="d-flex">
							<p class="mr-3">
								<i class="fa fa-user text-primary"></i> Admin
							</p>
							<p class="mr-3">
								<i class="fa fa-folder text-primary"></i> Web Design
							</p>
							<p class="mr-3">
								<i class="fa fa-comments text-primary"></i> 15
							</p>
						</div>
					</div>

					<!--대표사진 및 설명 + 신청 -->
					<div class="mb-5">
						<!-- 숨김.숨겨놓은 도전정보 / 유저정보-->
						<input id="challNo" name="challNo" type="hidden" th:value="${detailChall.challNo}" />
						<img th:src="|/imgView/${challImg[0].mediaServerFile}|" class="img-fluid rounded w-100 mb-4"
							alt="대표사진" />
						<div class="row pt-2 pb-4" style="justify-content: center;">
							<div class="col-6 col-md-12">
								<i class="fa-sharp fa-solid fa-share-nodes"></i>
								<h2 class="fa fa-regular fa-share text-primary"></h2>
								<h2 th:if="${myLike != null }" class="fa fa-regular fa-bookmark text-primary bmBtn">
								</h2>
								<h2 th:if="${myLike ==null }" class="fa fa-solid fa-bookmark text-primary bmBtn"
									style="font-weight: 100;"></h2>
								</th:block>
								<p class="mr-3">
									<i class="fa fa-users text-primary"></i>
									<span th:text="${detailChall.nowMem}"></span> 명 참여중
								</p>
								<h6>
									도전카테고리: <span th:text="${detailChall.challCategory}"></span>
								</h6>
								<h6>
									도전카테고리: <span th:text="${detailChall.challCategory}"></span>
								</h6>
								<h6>
									도전태그: <span th:text="${detailChall.challTag}"></span>
								</h6>
								<ul class="list-inline m-0">
									<li class="py-2 border-top border-bottom"><i
											class="fa fa-check text-primary mr-3"></i> 시작날짜: <span
											th:text="${detailChall.challStartdate}"></span></li>
									<li class="py-2 border-bottom"><i class="fa fa-check text-primary mr-3"></i> 도전기간:
										<span th:text="${detailChall.challFreq}"></span>주</li>
									<li><i class="fa fa-check text-primary mr-3"></i> 도전빈도: 주 <span
											th:text="${detailChall.challDuration}"></span> 회</li>
								</ul>
								<button>
									도전금액:<span th:text="${detailChall.challPrice}"></span>
								</button>
							</div>
							<a th:if="${memcheck == null } and ${#strings.equals(detailChall.challStatus, '시작 전')}" class="btn btn-primary mt-2 py-2 px-4" id="applyBtn">도전 신청하기</a>
							<a th:if="${memcheck !=null } and ${#strings.equals(detailChall.challStatus, '시작 전')}" class="btn btn-primary mt-2 py-2 px-4">이미 참여중인 도전</a> 
							<a th:if="${#strings.equals(detailChall.challStatus, '진행 중')}" class="btn btn-primary mt-2 py-2 px-4">진행 중인 도전입니다.</a>
							<a th:if ="${#strings.equals(detailChall.challStatus, '종료')}" class="btn btn-primary mt-2 py-2 px-4" >이미 종료된 도전입니다.</a>
						</div>
					</div>
				</div> <!-- 도전 대표사진 및 간단 설명 div end-->

				<!--줄 -->
					<div class="d-flex flex-column text-left mb-3">
						<div class="d-flex flex-column text-left mb-3">
							<p class="section-title pr-5"></p>
						</div>
						
						<!--한줄바 -->
						<div class="row">
							<div class="col-12 text-left mb-2">
								<ul class="list-inline mb-4" id="menu-filters">
									<li class="btn btn-outline-primary m-1 active" id="detailBtn">상세보기</li>
									<!-- <th:block th:if="${myInfo} and (${#strings.equals(detailChall.challStatus, '진행 중')} or ${#strings.equals(detailChall.challStatus, '종료')})"> -->
										<li class="btn btn-outline-primary m-1" th:if="${memcheck !=null}" id="vldBtn">인증하기</li>
										<li class="btn btn-outline-primary m-1" th:if="${memcheck !=null }" id="resultBtn">도전 달성률</li>
										<li class="btn btn-outline-primary m-1" th:if="${leaderInfo.userId == myInfo.userId }" id="memBtn">회원관리</li>
										<li class="btn btn-outline-primary m-1" th:if="${leaderInfo.userId == myInfo.userId }" id="vldRptBtn">인증 신고 관리</li>
									<!-- </th:block> -->
								</ul>
							</div>
						</div>
					</div>
					<!-- 메뉴 한줄 바 end -->
	
				<!--도전정보시작-->
				<div id="challContent" style="width: 700px">
					<!--여기는 상세정보 탭-->
					<h1 class="mb-3">Diam dolor est ipsum clita lorem</h1>
					<div class="d-flex">
						<p class="mr-3"> <i class="fa fa-user text-primary"></i> Admin </p>
						<p class="mr-3"> <i class="fa fa-folder text-primary"></i> Web Design </p>
						<p class="mr-3"> <i class="fa fa-comments text-primary"></i> 15 </p>
					</div>
						<div class="mb-5" id="detailC" style="display: inline-block; height: auto; overflow: hidden;">
							<p> 인증방법: <span th:text="${detailChall.vldMethod}"></span> </p>
							<h2 class="mb-4">Sucess Case</h2>
							<img th:src="|/imgView/${challImg[1].mediaServerFile}|" alt="vldSucess"
								class="img-fluid rounded w-50 float-left mr-4 mb-3" />
							<p style="width: 100;">이렇게 어쩌고저쩌고 하면 성공 계속길게 어쩌구저쩍</p>
							<h3 class="mb-4">Fail Case</h3>
							<img th:src="|/imgView/${challImg[2].mediaServerFile}|" alt="vldFail"
								class="img-fluid rounded w-50 float-left mr-4 mb-3" />
							<p>실패</p>
						</div>
					<!--여기는 상세정보 끝-->
					<!--상세정보 끝-->
					</div>

				</div> <!-- 상세보기 왼쪽 내용부분 end -->
				<!-- 도전정보 끝 -->

				<div class="col-lg-4 mt-5 mt-lg-0">
					<!-- 도전리더 프로필 -->
					<div
						class="d-flex flex-column text-center bg-primary rounded mb-5 py-5 px-4">
						<div th:if="${leaderInfo.memImage}">
						<p class="text-white">CHALLL LEADER</p>
							<!-- 도전리더 프로필 있는 경우-->
							<img th:src="|/imgView/${leaderInfo.memImage}|"
								class="img-fluid rounded-circle mx-auto mb-4"
								style="width: 200px; height:200px ; object-fit: cover" />
						</div>
						<h3 class="text-secondary mb-3" th:text="${leaderInfo.memNickname}"></h3>
						<p class="text-white m-0" th:text="${leaderInfo.memIntro}"></p>
					</div>
	
					<!-- Search Form -->
					<div class="mb-5">
						<form action="">
							<div class="input-group">
								<input type="text" class="form-control form-control-lg"
									placeholder="Keyword" />
								<div class="input-group-append">
									<span class="input-group-text bg-transparent text-primary"><i
										class="fa fa-search"></i></span>
								</div>
							</div>
						</form>
					</div>
	
					<!-- Single Image -->
					<div class="mb-5">
						<img src="img/blog-1.jpg" alt="" class="img-fluid rounded" />
					</div>
	
					<!-- Recent Post -->
					<div class="mb-5">
						<h2 class="mb-4">Recent Post</h2>
						<div
							class="d-flex align-items-center bg-light shadow-sm rounded overflow-hidden mb-3">
							<img class="img-fluid" src="img/post-1.jpg"
								style="width: 80px; height: 80px" />
							<div class="pl-3">
								<h5 class="">Diam amet eos at no eos</h5>
								<div class="d-flex">
									<small class="mr-3"><i class="fa fa-user text-primary"></i>
										Admin</small> <small class="mr-3"><i
										class="fa fa-folder text-primary"></i> Web Design</small> <small
										class="mr-3"><i class="fa fa-comments text-primary"></i>
										15</small>
								</div>
							</div>
						</div>
						<div
							class="d-flex align-items-center bg-light shadow-sm rounded overflow-hidden mb-3">
							<img class="img-fluid" src="img/post-2.jpg"
								style="width: 80px; height: 80px" />
							<div class="pl-3">
								<h5 class="">Diam amet eos at no eos</h5>
								<div class="d-flex">
									<small class="mr-3"><i class="fa fa-user text-primary"></i>
										Admin</small> <small class="mr-3"><i
										class="fa fa-folder text-primary"></i> Web Design</small> <small
										class="mr-3"><i class="fa fa-comments text-primary"></i>
										15</small>
								</div>
							</div>
						</div>
						<div
							class="d-flex align-items-center bg-light shadow-sm rounded overflow-hidden mb-3">
							<img class="img-fluid" src="img/post-3.jpg"
								style="width: 80px; height: 80px" />
							<div class="pl-3">
								<h5 class="">Diam amet eos at no eos</h5>
								<div class="d-flex">
									<small class="mr-3"><i class="fa fa-user text-primary"></i>
										Admin</small> <small class="mr-3"><i
										class="fa fa-folder text-primary"></i> Web Design</small> <small
										class="mr-3"><i class="fa fa-comments text-primary"></i>
										15</small>
								</div>
							</div>
						</div>
					</div>
	
					<!-- Single Image -->
					<div class="mb-5">
						<img src="img/blog-2.jpg" alt="" class="img-fluid rounded" />
					</div>
	
					<!-- Tag Cloud -->
					<div class="mb-5">
						<h2 class="mb-4">Tag Cloud</h2>
						<div class="d-flex flex-wrap m-n1">
							<a href="" class="btn btn-outline-primary m-1">Design</a> <a
								href="" class="btn btn-outline-primary m-1">Development</a> <a
								href="" class="btn btn-outline-primary m-1">Marketing</a> <a
								href="" class="btn btn-outline-primary m-1">SEO</a> <a href=""
								class="btn btn-outline-primary m-1">Writing</a> <a href=""
								class="btn btn-outline-primary m-1">Consulting</a>
						</div>
					</div>
	
					<!-- Single Image -->
					<div class="mb-5">
						<img src="img/blog-3.jpg" alt="" class="img-fluid rounded" />
					</div>
	
					<!-- Plain Text -->
					<div>
						<h2 class="mb-4">Plain Text</h2>
						Aliquyam sed lorem stet diam dolor sed ut sit. Ut sanctus erat ea
					</div>
				</div>
			</div>
		</div>
	
	<!-- Detail End -->


	<!-- Footer Start -->
	<div
		class="container-fluid bg-secondary text-white mt-5 py-5 px-sm-3 px-md-5">
		<div class="row pt-5">
			<div class="col-lg-3 col-md-6 mb-5">
				<a href=""
					class="navbar-brand font-weight-bold text-primary m-0 mb-4 p-0"
					style="font-size: 40px; line-height: 40px"> <i
					class="flaticon-043-teddy-bear"></i> <span class="text-white">KidKinder</span>
				</a>
				<p>Labore dolor amet ipsum ea, erat sit ipsum duo eos. Volup
					amet ea dolor et magna dolor, elitr rebum duo est sed diam elitr.
					Stet elitr stet diam duo eos rebum ipsum diam ipsum elitr.</p>
				<div class="d-flex justify-content-start mt-4">
					<a
						class="btn btn-outline-primary rounded-circle text-center mr-2 px-0"
						style="width: 38px; height: 38px" href="#"><i
						class="fab fa-twitter"></i></a> <a
						class="btn btn-outline-primary rounded-circle text-center mr-2 px-0"
						style="width: 38px; height: 38px" href="#"><i
						class="fab fa-facebook-f"></i></a> <a
						class="btn btn-outline-primary rounded-circle text-center mr-2 px-0"
						style="width: 38px; height: 38px" href="#"><i
						class="fab fa-linkedin-in"></i></a> <a
						class="btn btn-outline-primary rounded-circle text-center mr-2 px-0"
						style="width: 38px; height: 38px" href="#"><i
						class="fab fa-instagram"></i></a>
				</div>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h3 class="text-primary mb-4">Get In Touch</h3>
				<div class="d-flex">
					<h4 class="fa fa-map-marker-alt text-primary"></h4>
					<div class="pl-3">
						<h5 class="text-white">Address</h5>
						<p>123 Street, New York, USA</p>
					</div>
				</div>
				<div class="d-flex">
					<h4 class="fa fa-envelope text-primary"></h4>
					<div class="pl-3">
						<h5 class="text-white">Email</h5>
						<p>info@example.com</p>
					</div>
				</div>
				<div class="d-flex">
					<h4 class="fa fa-phone-alt text-primary"></h4>
					<div class="pl-3">
						<h5 class="text-white">Phone</h5>
						<p>+012 345 67890</p>
					</div>
				</div>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h3 class="text-primary mb-4">Quick Links</h3>
				<div class="d-flex flex-column justify-content-start">
					<a class="text-white mb-2" href="#"><i
						class="fa fa-angle-right mr-2"></i>Home</a> <a class="text-white mb-2"
						href="#"><i class="fa fa-angle-right mr-2"></i>About Us</a> <a
						class="text-white mb-2" href="#"><i
						class="fa fa-angle-right mr-2"></i>Our Classes</a> <a
						class="text-white mb-2" href="#"><i
						class="fa fa-angle-right mr-2"></i>Our Teachers</a> <a
						class="text-white mb-2" href="#"><i
						class="fa fa-angle-right mr-2"></i>Our Blog</a> <a class="text-white"
						href="#"><i class="fa fa-angle-right mr-2"></i>Contact Us</a>
				</div>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h3 class="text-primary mb-4">Newsletter</h3>
				<form action="">
					<div class="form-group">
						<input type="text" class="form-control border-0 py-4"
							placeholder="Your Name" required="required" />
					</div>
					<div class="form-group">
						<input type="email" class="form-control border-0 py-4"
							placeholder="Your Email" required="required" />
					</div>
					<div>
						<button class="btn btn-primary btn-block border-0 py-3"
							type="submit">Submit Now</button>
					</div>
				</form>
			</div>
		</div>
		<div class="container-fluid pt-5"
			style="border-top: 1px solid rgba(23, 162, 184, 0.2);">
			<p class="m-0 text-center text-white">
				&copy; <a class="text-primary font-weight-bold" href="#">Your
					Site Name</a>. All Rights Reserved.

				<!--/*** This template is free as long as you keep the footer author’s credit link/attribution link/backlink. If you'd like to use the template without the footer author’s credit link/attribution link/backlink, you can purchase the Credit Removal License from "https://htmlcodex.com/credit-removal". Thank you for your support. ***/-->
				Designed by <a class="text-primary font-weight-bold"
					href="https://htmlcodex.com">HTML Codex</a> <br />Distributed By:
				<a href="https://themewagon.com" target="_blank">ThemeWagon</a>
			</p>
		</div>
	</div>
	<!-- Footer End -->


	<script>
    //토큰있어야 post가능~!
    /*<![CDATA[*/
    var header = '[[${_csrf.headerName}]]';
     var token = '[[${_csrf.token}]]';
       console.log(header);
       console.log(token);
     /*]]>*/
	//
	
	
	
	//----자주쓰는애들 정의 지금 1. 지금 상세보는 도전번호  2. 로그인한 회원아이디
	let challNo = $('#challNo').val();
	let userId = $('#userId').val();
	
    //도전 신청으로 이동하기   --> 여유가되면 모달로 띄우기...^^;
    $('#applyBtn').on("click", function () {
		console.log("도전신청");
     	location.href = '/own/chall/applyForm?challNo=' + challNo + '&&userId=' + userId;
    });
    
    //메뉴 클릭 색깔 변경 이벤트
    $('#menu-filters li').click(function(){
    	$('#menu-filters li').removeClass('active');
    	$(this).addClass('active');
    })
    
	//--------------------------모달모달----------------------------------------------
		
	
	
	//-------------------------- 모달모달 끝-----------------------------------------
	
	//좋아요 북마크 버튼 아작스
	$('.bmBtn').click(function(){
		console.log("북마크 버튼 클릭")
		let category = "Chall";
        $.ajax({
			url:'/own/likeAjax',
			method: 'post',
			data: JSON.stringify({userId: userId,
							      categoryNo: challNo,
							      category: category
								}),
			beforeSend : function(xhr){
						xhr.setRequestHeader(header, token);
			}, 
			contentType: "application/json",
			success:function(res){
				console.log(res);
				if(res == 'add'){
					alert("북마크에 추가 완료.")
				$('.bmBtn').removeAttr('style');					
				}
				else if(res == 'del'){
					alert("북마크 해제 완료.")
				$('.bmBtn').attr('style', 'font-weight: 100')
				}
				else{
					alert('다시 시도해주세요!');
				}
			},
			error:function(err){
				console.log(err);
			}
		})
	})

    //-------------------------------상세보기-------------------------------------
      /* 상세보기 버튼 */
    $('#detailBtn').on("click", function () {
      $("#challDetail").css('display', 'inline-block');
      $("#challVld").css('display', 'none');
      $("#challResult").css('display', 'none');
      $("#challMem").css('display', 'none');
	  $("#vldRpt").css('display', 'none');
    })

    //--------------------------------인증하기-------------------------------------

    $('#vldBtn').on('click', function(){
	   $('#challContent').load("/own/chall/vldPageList?challNo="+challNo);
	});
    
    /*인증하기 버튼*/
/*     $('#vldBtn').on("click", function () {
      $("#challVld").css('display', "inline-block");
      $("#challDetail").css('display', 'none');
      $("#challResult").css('display', 'none');
      $("#challMem").css('display', 'none');
	  $("#vldRpt").css('display', 'none');

      let vldButton = $('#vldFormSubmit');
      console.log(challNo, userId);
      console.log($("#resultCheck").val());

	  //처음보여주는 아작스페이징!
      if($("#vldCheck").val() == "false"){
		//인증내역 페이징 아작스
		$.ajax({
          url: '/own/chall/vldPageListAjax',
          method: 'get',
		  data: {page:1,
				 pageUnit:4,
			     pageSize:5,
				 challNo: challNo},
          success: function(result){
            console.log(result);
            result.forEach( vld => {
              makeVldForm(vld)
            });
			let pagingName = 'vldPaging';
			makePaging(result, pagingName);
          },
          error: function(err){
            console.log(err);
          }
        });
        //인증횟수 확인하고 버튼 설정바꾸기
			$.ajax({
			url:'/own/chall/vldCheckAjax',
			method: 'post',
			data: JSON.stringify({ userId: userId,
								  challNo: challNo
								 }),
			beforeSend : function(xhr){
						xhr.setRequestHeader(header, token);
			}, 
			contentType: "application/json",
			success: function(result){
			if(result == 1){
				console.log('인증가능');
			} else if(result == 2){
				console.log("이미 오늘 인증 완료.")
				// $('#vldAddModal').removeClass('modalBtn').text('오늘 인증 완료.');
				$('#vldAddModal').attr('style', 'display:none');
				console.log($('#vldAddModal').parent());
				$('#vldAddModal').parent().prepend(('<p>오늘인증 완료하였습니다</p>'));
			} else if(result == 3 ){
				console.log("이번 주 인증완료.")
				$('#vldAddModal').attr('style', 'display:none').text('오늘 인증 완료.');
			} else{
				console.log("오류가 발생하였습니다.");
				alert('오류가 발생하였습니다.');
				$('#vldAddModal').attr('style', 'display:none').text('오늘 인증 완료.');
			}
			},
			error: function(err){
				console.log(err)
			}
		});
		$("#vldCheck").val("true");
		}
	}); //인증하기 첫버튼 끝 */

	    // 전체도전 아작스 번호이동.
		$('#vldPaging').on('click', '.pagePort', function(){
			$('#myVldPaging').empty();
		    //페이지번호 + 밴드식별번호
		    let page = $(this).attr('value');
			console.log(page)
		    console.log($(this).attr('value')); 
		    $.ajax({
		       url: '/own/chall/vldPageListAjax',
		       method: 'get',
			   data: {page:page, pageUnit:4, pageSize:5, challNo: challNo}
		    }).then(result => {
		       console.log(result);
				//형태만들기 이미있는애들 없애준다.. -> 도전폼
				let Chall = $('#vldImg');
				$('#vldImg').empty();
				//다시 형태 붙이는애 만들어주기..
				result.forEach( vld => {
					makeVldForm(vld);
		       	})
				let pagingName = 'vldPaging';
				makePaging(result, pagingName);
				})
		});

		//첫 all페이지 불러오는 아작스 함수..
		function allVldAjax(){
			//페이징없애기..
			//$('#myVldPaging').empty();
			console.log("인증하기")
			//인증내역 페이징 아작스
			$.ajax({
			url: '/own/chall/vldPageListAjax',
			method: 'get',
			data: {page:1,
					pageUnit:4,
					pageSize:5,
					challNo: challNo},
			success: function(result){
				console.log(result);
				result.forEach( vld => {
				makeVldForm(vld)
				});
				let pagingName = 'vldPaging';
				makePaging(result, pagingName);
			},
			error: function(err){
				console.log(err);
			}
			})
		}

		//올 버튼 누를때 전체불러오는 아작스..
		$('#allVldPage').on('click', function(){
			console.log($('#myVldPaging'));
			//페이징지우고, 내용칸 지우기.
			$('#myVldPaging').empty();
			let Chall = $('#vldImg');
			$('#vldImg').empty();
			console.log("불러올까요? 아작스?");
			allVldAjax()
		});

		//인증버튼 메뉴 my/all 색깔 이벤트
		$('#myVldPage li').click(function(){
			$('#myVldPage li').removeClass('active');
			$(this).addClass('active');
    	})

	//-----------------------------------내도전페이징--------------------------------------------- 

		//점 어설프노..
		//마이 눌렀을때 첫 페이지   --자꾸 위에 정의해놓은 userId 가져가노...ㅠㅠ
		$('#onlyMyVldPage').on('click', function() {
			$('#vldPaging').empty();
		    //페이지번호 + 밴드식별번호
		    let myId = $(this).attr('value');
		    $.ajax({
				url: '/own/chall/vldPageListAjax',
				method: 'get',
				data: { page:1,
						pageUnit:4,
						pageSize:5,
						challNo: challNo,
						userId: myId},
				success: function(result){
					console.log(result);
					//처음불러온애들
					let Chall = $('#vldImg');
					$('#vldImg').empty();
					//다시 형태 붙이는애 만들어주기..
					result.forEach( vld => {
						makeVldForm(vld)
					});
					//페이징버튼...
					let pagingName = 'myVldPaging';
					makePaging(result, pagingName);
				},
				error: function(err){
					console.log(err);
				}
        	})    
		});

		// 내 인증 페이징 버튼 아작스.
		$('#myVldPaging').on('click', '.pagePort', function(){
		    //페이지번호 + 밴드식별번호
		    let page = $(this).attr('value');
			console.log(page)
		    console.log($(this).attr('value')); 
			console.log("유저 아이디..위에 선언한거...."+userId);
		    $.ajax({
		       url: '/own/chall/vldPageListAjax',
		       method: 'get',
			   data: { page: page,
					   pageUnit:4,
					   pageSize:5,
					   challNo: challNo,
					   userId: userId}
		    }).then(result => {
		       console.log(result);
				//형태만들기 이미있는애들 없애준다.. -> 도전폼
				let Chall = $('#vldImg');
				$('#vldImg').empty();
				//다시 형태 붙이는애 만들어주기..
				result.forEach(vld => {
					makeVldForm(vld);
		       	})
				let pagingName = 'myVldPaging';
				makePaging(result, pagingName);
				})
		    });


	//버튼 초기화
	/* 아작스 페이징 버튼 */
	function makePaging(result, pagingName){
			//버튼 다시초기화..비우기
			$(`#${pagingName}`).empty();
		    let pagingM = result[0].paging;
		    //시작 버튼
		    console.log(result[0]); //첫번째? 가져오기..?
		    let startpageTag = $('<ul class="pagination" />');
		    $(`#${pagingName}`).append(startpageTag);
		    //이전 버튼만들기
		    if(pagingM.startPage>1){
			let pageBeforTag = `<li class="page-item">
                                <a class="page-link pagePort" aria-label="Previous" value=${pagingM.startPage-1}>
                                <span aria-hidden="true"> <-
								<span class="lnr lnr-chevron-left pagePort"></span></span></a>
                                </li>`
            startpageTag.append(pageBeforTag); 
		    }               
			//페이지목록..
		    for(let pg = pagingM.startPage; pg<=pagingM.endPage; pg++){
		            if(pg != pagingM.page){
		            	let pageTag = `<li class="page-item">
		                               <a class="page-link pagePort" value=${pg}>${pg}</a>
		                               </li>`
		                startpageTag.append(pageTag);
		            } else if(pg == pagingM.page ){
						 let pageTag =  `<li class="page-item active">
							<a class="page-link" >${pg}</a>
							</li>`
							startpageTag.append(pageTag);
					}
			}               
			//이후 버튼만들기
			if(pagingM.endPage<pagingM.lastPage){
						let pageAfterTag =`<li class="page-item">
							<a class="page-link pagePort" aria-label="Next" value=${pagingM.endPage+1}>
								<span aria-hidden="true"> ->
								<span class="lnr lnr-chevron-right"></span></span></a>
								</li>`
								startpageTag.append(pageAfterTag);
							}
							$(`#${pagingName}`).append(startpageTag);
		};

    /* 인증내역 아작스로읽어와서 사진폼으로 만들기*/
    function makeVldForm(vld){
      let userId = vld.userId;
      let mediaName = vld.mediaServerFile;
      let vldDate = (vld.vldDate);
      let vldNo = (vld.vldNo);
      let gridVld = `<div class="grid" style="padding: 10px" id=${vldNo}>
      					<div class="card card__one">
							<figure class="card__img">
								<img src=/imgView/${mediaName} style="width: 320px; height:230px ; object-fit: cover"/>
							</figure>
						<div class="card__desc vldno">
								<input class="vldNum" type="hidden" value=${vldNo}>
								<p>${userId}</p>
							</div>
						</div>
					</div>`		
	   $('#vldImg').append(gridVld);				
 	  /*   $('#vldImg').append(firstdiv.append(secondDiv.append(imgDiv, hTag))) */ 
    }
    
    //모달엑스누르면..초기화될 아이들..ㅋ
	$('.close').on('click',function(){
		$('#reportArea').attr('style', 'display:none');
		console.log($('#rptReason').val(""));
		$('#rptBtn').attr('style', 'display:block');
		console.log('왜안되나'); 
	});

	//모달 인증신고 인증 신고 -------------------------------------------------------------------------

	//인증이미지 클릭 시 모달 띄우기
	$('#vldImg').on('click','.grid',function(e){
		console.log(this); //이 창을.. 클릭하면 모달띄우기..
		//gird에 아이디값으로 식별번호 넣어둔거 읽어오기
		console.log("=========================");
		console.log($(this).attr('id'));
		let vldNo = $(this).attr('id'); //id에 넣어둔 인증식별번호
		let vldDtImg = $(this).find('img').attr('src'); //이미지 경로 읽어오기
		let vldDtId = $(this).find('p').text(); //p 안에 넣어둔 값 읽어오기 - 아이디
		let vldDtNo = $(this).find('input').val(); //인풋 히든으로 넣어온 값읽어오기 -> 나중에 날짜로
		//각자 태그찾아서 값넣기~! 아이디값으로 넣어도되지않을까합니다..나중에...
		$('#vldReport h1').text("오 성공");
		$('#vldReport img').attr('src', vldDtImg);
		$('#vldReport h3').text(vldDtId);
		//첫번째 인풋값에 인증번호 넣기.
		$('#vldReport input').eq(0).val(vldNo);

		//신고여부 확인.
		$.ajax({
	        url:'/own/chall/checkRptAjax?vldNo='+ vldNo + '&&reporter=' + userId,
	        method: 'get',
	        success: function(result){
	        		if(result > 0 || userId == vldDtId){
		          		console.log(result);
						$('#rptBtn').attr('style', 'display:none');
						//$('#rptBtn').replaceWith('<p>이미 신고한 인증입니다.</p>');
	        		}else {
						$('#rptBtn').attr('style', 'display:block');
	        			console.log('신고신청 가능 or s내 아이디 신고불가 ');
	        		}
	        },
	        error: function(err){
	          	console.log(err);
	        }
      	})		
	});

	//신고하기 누르면 신고폼 display block
	$('#rptBtn').on('click', function(e){
		console.log(e);
		console.log($(e).parent());
		// console.log(this.parent());
		console.log($(this).parent().find('input').val());
		$('#reportArea').attr('style', 'display:block');
	});

	//신고제출 버튼...
	$('#rptAddBtn').on('click', function(){
			console.log('신고제출 버튼');
			let vldRealNo = $(this).parent().parent().find('input').val();
			console.log(vldRealNo);
			// console.log($(this).parent().find('input').val());
			//신고사유
			console.log($('#rptReason').val());
			console.log("---------지금도전번호----" + challNo);
			console.log("---------지금로그인아이디 신고하는 사람----" + userId);
			let rptReason = $('#rptReason').val();
			let cutChallNo  = challNo.substr(4);
			console.log(cutChallNo);
	        $.ajax({
	            url:'/own/chall/addRptAjax',
	            method: 'post',
	            data: JSON.stringify({vldNo: vldRealNo,
	                                  reporter: userId,
	                                  reportReason: rptReason
	                                }),
	            beforeSend : function(xhr){
	                          xhr.setRequestHeader(header, token);
	            }, 
	            contentType: "application/json",
	            success: function(result){
					console.log(result);
	              if(result > 0){
	                console.log('신고 처리완.');
	                alert('신고가 완료되었습니다.');
	                location.href = '/own/chall/detailChall?challNo=' + cutChallNo
	              } else {
	                alert('오류가 발생하였습니다. 다시 시도해주세요.');
	              } 
	            },
	            error: function(err){
	              console.log(err)
	            }
	          })
		});
    
    //--------------------------------달성률-------------------------------------

     /*달성률 버튼*/
    $('#resultBtn').on("click", function () {
      $("#challResult").css("display", "inline-block");
      $("#challVld").css('display', 'none');
      $("#challDetail").css('display', 'none');
      $("#challMem").css('display', 'none')
	  $("#vldRpt").css('display', 'none');

	  let duration = $('#challDur').val();
	  let freq = $('#challFreq').val();
	  let challVldCount = duration * freq;
	  console.log("----도전 전체 인증횟수"+challVldCount);
	  //내 인증횟수 카운트로 가져오기 ㅎ
	  //현재 챌린지 회원들의 평균 인증 횟수..

	  $.ajax({
	        url:'/own/chall/vldCountAvgAjax?userId='+ userId + '&&challNo=' + challNo,
	        method: 'get',
	        success: function(result){
	        		console.log(result);
					let myVld =  result.myVld;
					let nowMem = $('#nowMem').val();
					console.log("----도전 현재멤버"+nowMem);
					let memVld = (result.memVldAvg);
					console.log("----내가한 인증횟수"+myVld);
					console.log("----멤버 전체 횟수"+memVld);
					let memVldAvg=memVld/nowMem;
					console.log("----전체도전횟수/멤버수"+memVldAvg)
					var myChart = new Chart(context, {
						type: 'doughnut',
						data: {
							labels: [
								'나의 인증 성공 횟수',
								'남은 인증 횟수'
							  ],  
							  datasets: [{
								  label: '나의 인증',
								  data: [myVld, challVldCount - myVld],
								  backgroundColor: [
									  'rgb(54, 162, 235)',
									  'rgb(255, 205, 86)'
								  ],
								  hoverOffset: 4
							  }]
						  }
					});
					var memChart = new Chart(context2, {
						type: 'doughnut',
						data: {
							labels: [
								'멤버 평균 성공 횟수',
								'남은 인증 횟수'
							  ],  
							  datasets: [{
								  label: '멤버 평균 인증',
								  data: [memVldAvg, challVldCount - memVldAvg],
								  backgroundColor: [
									  'rgb(54, 162, 235)',
									  'rgb(255, 205, 86)'
								  ],
								  hoverOffset: 4
							  }]
						  }
					  });
					},
					error: function(err){
						console.log(err)
					}
				})
				
	
	  
	  //달성률 구글차트
		var context = document.getElementById('myChart').getContext('2d');
		var context2 = document.getElementById('memChart').getContext('2d');

		let chStatus = $('#challSt').val();
		console.log(chStatus);
		if($("#resultCheck").val() == "false" && chStatus =="종료") {
			//달성결과 값 불러오기...
			$.ajax({
				url:'/own/chall/challResultAjax',
				method:'get',
				data: { challNo:challNo,
				    userId: userId },
					success:function(res){
						console.log(res.rewardPrice);
						console.log(res);
						if(res.rewardPrice === undefined){
							console.log("결과가없음. 아직 종료 노노");
						} else {
							console.log("결과가 있음.")
							let sucessPer = res.successRate * 100;
							let rewardsultTag = `<h4>달성률: ${sucessPer}%</h4>
								<ul>
								<li><h5>예상 도전 환급 금액: ${res.refundPrice}</h5></li>
								<li><h5>예상 도전 상금 금액: ${res.rewardPrice}</h5></li>
							</ul>`;
							$('#rsChallShow').append(rewardsultTag);
						}
					},
					error: function(err){
						console.log(err);
					}
				});
			}
			$("#resultCheck").val("true");
		})
    
    //-----------------------------리더만 신청회원보기-------------------------------------
   
    /*멤버 리스트 버튼 ul li 만들기*/ 
    $('#memBtn').on("click", function () {
      $("#challMem").css("display", "inline-block");
      $("#challDetail").css('display', 'none');
      $("#challVld").css('display', 'none');
      $("#challResult").css('display', 'none');
	  $("#vldRpt").css('display', 'none');
      console.log($("#challMemCheck").val());
      if($("#challMemCheck").val() == "false"){
		  let memWait = "대기";
		  let nowMem = "승인";
        $.ajax({
			//대기인원 검색.
          url: '/own/chall/challMemList?challNo=' + challNo + '&&memStatus=' + memWait,
          method: 'get',
          success: function (result) {
            console.log(result)
            let ul = $("<ul />")
            result.forEach(mem => {
              console.log(mem.userId, mem.memStatus)
              ul.append($("<li />").text(mem.userId + mem.memStatus)
              .append($("<button />").text('승인').attr('onclick', 'authChange(this)'), $("<button />").text('거절').attr('onclick', 'authChange(this)')));
            })
            $("#waitMemList").append(ul);
          },
          error: function (err) {
            console.log(err)
          }
        }),
		$.ajax({
			url: '/own/chall/challMemList?challNo=' + challNo + '&&memStatus=' + nowMem,
			method: 'get',
			success: function (result) {
				console.log(result)
				let ul = $("<ul />")
				result.forEach(mem => {
				console.log(mem.userId, mem.memStatus)
				ul.append($("<li />").text(mem.userId + mem.memStatus)
				.append($("<button />").text('승인').attr('onclick', 'authChange(this)'), $("<button />").text('거절').attr('onclick', 'authChange(this)')));
				})
				$("#nowMemList").append(ul);
			},
			error: function(err){
				console.log(err);
			}
		})
      }
      $("#challMemCheck").val("true");
    })
    
     /* 멤버 승인, 거절 버튼 -> 권한변경*/
    function authChange(e){
      console.log("이벤트 텍스트 "+$(e).text());
      let memId = $(e).parent().text().substring(0,3);
      let memStatus = $(e).text();
      $.ajax({
        url: '/own/chall/challMemAuth',
        method: 'post',
        data: JSON.stringify({userId: memId,
                              challNo: challNo,
                              memStatus: memStatus
                            }),
        beforeSend : function(xhr){
                      xhr.setRequestHeader(header, token);
        }, 
        contentType: "application/json",
        success: function(result){
          console.log(result)
		  alert(result);
		  console.log($(e).parent().remove());
        },
        error: function(err){
          console.log(err)
        }
      })
    }
 
	//-----------------------------인증신고 관리 - 리더만 가능.--------------------------------

	$('#vldRptBtn').on('click', function(){
		$("#challVld").css('display', 'none');
      	$("#challDetail").css('display', 'none');
      	$("#challResult").css('display', 'none');
      	$("#challMem").css('display', 'none');
		$("#vldRpt").css('display', 'inline-block');

		if($("#vldCheck").val() == "false"){
			console.log("인증신고 관리하는 곳.");
			let reportState = "처리 중";
			$.ajax({
				url:'/own/chall/reportListAjax',
				method:'get',
				data: { challNo: challNo,
						reportState: reportState},
				success: function(res){
					console.log(res);
					res.forEach( result => {
						console.log(result);
						console.log("신고번호==" + result.vldNo);
						console.log(result.reportReason);
						makeRptVldForm(result);
					})
				},
				error: function(err){
					console.log(err);
				}
			})
		}
		$("#vldCheck").val("true");
	})

		function makeRptVldForm(vld){
		console.log(vld);
		let userId = vld.userId;
		let mediaName = vld.vldImg;
		let vldDate = (vld.vldDate);
		let vldNo = vld.vldNo;
		let reportRs = vld.reportReason;
		//신고당한사람
		let reported = vld.reported;
		let reporter = vld.reporter;
		console.log(mediaName);
		console.log(reported);
		let gridVld = `<div class="grid" style="padding: 10px" id=${vldNo}>
							<div class="card card__one" style="width: 330px; height:350px;" >
								<figure class="card__img">
									<img src=/imgView/${mediaName} 
									style="object-fit: cover"/>
								</figure>
							<div class="card__desc vldno">
									<input type="hidden" value=${vldNo}>
									<input type="hidden" value=${reporter}>
									<p>${reportRs}</p>
									<p>신고당한 사람: ${reported}</p>
									<button onclick="vldProcess(this)">신고 승인</button>
									<button onclick="vldProcess(this)">신고 반려</button>
								</div>
							</div>
						</div>`		
		$('#vldRptList').append(gridVld);				
		/*   $('#vldImg').append(firstdiv.append(secondDiv.append(imgDiv, hTag))) */ 
		}

		function vldProcess(e){
			console.log($(e).parent().parent().parent());
			let girdRpt = $(e).parent().parent().parent();
			console.log($(e).text());
			console.log($(e).parent().find('input').eq(0).val());
			console.log($(e).parent().find('input').eq(1).val());
			let vldNo = $(e).parent().find('input').eq(0).val();
			let reporter = $(e).parent().find('input').eq(1).val();
			let rptAuth = $(e).text();
			console.log(vldNo);
			console.log(reporter);
			console.log(rptAuth);
				$.ajax({
				url: '/own/chall/reportProcess',
				method: 'post',
				data: JSON.stringify({ vldNo: vldNo,
									   reporter: reporter,
									   reportState: rptAuth
									}),
				beforeSend : function(xhr){
							xhr.setRequestHeader(header, token);
				}, 
				contentType: "application/json",
				success: function(result){
					alert(result);
					console.log(result)
					console.log($(e).parent().parent().parent().remove());
				},
				error: function(err){
					console.log(err)
				}
      		});
		};

	//----------------------------첨부파일 화면에 띄우기------------------------------------

      	/* att_zone : 이미지들이 들어갈 위치 id, btn : file tag id */
        imageView = function imageView(att_zone, btn){

            var attZone = document.getElementById(att_zone);
            var btnAtt = document.getElementById(btn)
            var sel_files = [];
            
            // 이미지와 체크 박스를 감싸고 있는 div 속성
            var div_style = 'display:inline-block;position:relative;'
                        + 'width:500px;height:auto;margin:5px;z-index:1';
            // 미리보기 이미지 속성
            var img_style = 'width:100%;height:100%;z-index:none';
            // 이미지안에 표시되는 체크박스의 속성
            var chk_style = 'width:40px;height:40px;position:absolute;font-size:30px;'
                        + 'right:0px;bottom:0px;z-index:999;background-color:rgba(255,255,255,0.1);color:blue';
        
            btnAtt.onchange = function(e){
            var files = e.target.files;
            var fileArr = Array.prototype.slice.call(files)
            for(f of fileArr){
                imageLoader(f);
            }
            }  
        
            // 탐색기에서 드래그앤 드롭 사용
            attZone.addEventListener('dragenter', function(e){
            e.preventDefault();
            e.stopPropagation();
            }, false)
            
            attZone.addEventListener('dragover', function(e){
            e.preventDefault();
            e.stopPropagation();
            
            }, false)
        
            attZone.addEventListener('drop', function(e){
            var files = {};
            e.preventDefault();
            e.stopPropagation();
            var dt = e.dataTransfer;
            files = dt.files;
            for(f of files){
                imageLoader(f);
            }
            }, false)
            
            /*첨부된 이미리즐을 배열에 넣고 미리보기 */
            imageLoader = function(file){
            sel_files.push(file);
            var reader = new FileReader();
            reader.onload = function(ee){
                let img = document.createElement('img')
                img.setAttribute('style', img_style)
                img.src = ee.target.result;
                attZone.appendChild(makeDiv(img, file));
            }
            reader.readAsDataURL(file);
            }
            
            /*첨부된 파일이 있는 경우 checkbox와 함께 attZone에 추가할 div를 만들어 반환 */
            makeDiv = function(img, file){
            var div = document.createElement('div')
            div.setAttribute('style', div_style) 
            var btn = document.createElement('input')
            btn.setAttribute('type', 'button')
            btn.setAttribute('value', 'x')
            btn.setAttribute('delFile', file.name);
            btn.setAttribute('style', chk_style);
            btn.onclick = function(ev){
                var ele = ev.srcElement;
                var delFile = ele.getAttribute('delFile');
                for(var i=0 ;i<sel_files.length; i++){
                if(delFile== sel_files[i].name){
                    sel_files.splice(i, 1);      
                }
                }
                dt = new DataTransfer();
                for(f in sel_files) {
                var file = sel_files[f];
                dt.items.add(file);
                }
                btnAtt.files = dt.files;
                var p = ele.parentNode;
                attZone.removeChild(p)
            }
            div.appendChild(img)
            div.appendChild(btn)
            return div
            }
        }('att_zone', 'btnAtt') 

  </script>
</body>
</div>
</html>