<!doctype html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/default_layout}" lang="ko">

<head>
	<!-- jquery -->
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
	<meta content="width=device-width, initial-scale=1.0" name="viewport" />
	<meta content="Free HTML Templates" name="keywords" />
	
	<!-- Libraries Stylesheet -->
	<link href="/css/chall/lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet" />
	<link href="/css/chall/lib/lightbox/css/lightbox.min.css" rel="stylesheet" />

	<!-- JavaScript Libraries -->
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
	<script src="/css/chall/lib/easing/easing.min.js"></script>
	<script src="/css/chall/lib/owlcarousel/owl.carousel.min.js"></script>
	<script src="/css/chall/lib/isotope/isotope.pkgd.min.js"></script>
	<script src="/css/chall/lib/lightbox/js/lightbox.min.js"></script>

	<!-- 모달 사진효과 -->
	<link href="/css/chall/css/chall.css" rel="stylesheet" />
	
	<!-- google chart -->
	<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.min.js"></script>
	<meta charset="utf-8">
	<style>
		ul {
			list-style: none;
			padding-left: 0px;
		}
	</style>
	<title>OWN _ 도전 상세</title>
</head>

<div layout:fragment="content">
	<body>
 		<!-- Banner Start -->
		 <div class="container-fluid bg-primary mb-3" style="padding: 0">
			<div class="d-flex flex-column align-items-center" style="min-height: 300px; justify-content: space-around; background-image:url(/img/chall/main/tennis.jpg)">
				<div class="justify-content-center" style="height: 150px;">
					<h4 class="text-center" style="color: white; margin-top: 30px;">오늘의 운동</h4>
					<h2 class="text-center" style="color: white;">chall</h2>
				</div>
			</div>
		</div>
		<!-- Banner End -->

		<!-- Detail Start -->
		<div class="container py-5">
			<div class="row pt-5">
				<div class="col-lg-8">
					<div style="width: 700px">
						<div class="d-flex flex-column text-left mb-3">
							<p class="section-title pr-5">
								<span class="pr-2">About Challenges</span>
							</p>
							<div class="d-flex" style="padding-left: 20px;">
								<h1 class="mb-3" th:text="${detailChall.challTitle}"></h1>
									<th:block th:if="${session.loginUser}">
										<button class="btn btn-primary mt-2 py-2 px-4" th:if="${leaderInfo.userId == session.loginUser.userId} and ${detailChall.nowMem == 0}" id="delChall">도전삭제</button>
									</th:block>
								<div style="margin-left: auto; margin-right: 10px;">
									<h1 th:if="${myLike != null }" class="fa fa-regular fa-bookmark text-primary bmBtn" style="margin: 3px;"></h1>
									<h1 th:if="${myLike == null }" class="fa fa-solid fa-bookmark text-primary bmBtn" style="font-weight: 100;"></h1>
								</div>
							</div>
							<h5 class="pl-3">[[${detailChall.challCategory}]]</h5>
						</div>

						<!--대표사진 및 설명 + 신청 -->
							<div style="width: 700px; display: flex; justify-content: center;">
								<img th:src="|/imgView/${challImg[0].mediaServerFile}|" class="img-fluid rounded mb-4"
								 style="width: 650px; height: 430px;object-fit: cover;" alt="대표사진" />
							</div>
							<div class="row pt-2 pb-4" style="justify-content: center;">
								<div class="col-4 col-md-12" style="display: flex; justify-content: center;">
									<div style="width: 400px;display: inline-block;">
										<ul class="list-inline m-0">
											<li class="py-2 border-bottom"><i class="fa fa-check text-primary mr-3"></i>
												시작날짜: <span th:text="${#dates.format(detailChall.challStartdate, 'M/d')}"></span>시작</li>
											<li class="py-2 border-bottom"><i class="fa fa-check text-primary mr-3"></i>
												도전기간: <span th:text="${detailChall.challDuration}"></span>주 동안</li>
											<li class="py-2 border-bottom"><i class="fa fa-check text-primary mr-3"></i>
												도전빈도: 주 <span th:text="${detailChall.challFreq}"></span> 회</li>
											<li class="py-2 "><i class="fa fa-check text-primary mr-3"></i>
												도전금액: <span th:text="${detailChall.challPrice}"></span> 원</li>
										</ul>
									</div>

									<div style="width: 250px; text-align: center;" class="pl-3 pt-3">
											<h5 style="padding: 3px; text-align: center; ">
												<i class="fa fa-users text-primary"></i>
												<span id="nowMemCnt" th:text="${detailChall.nowMem}"></span> / <span th:text="${detailChall.maxMem}"></span> 명 참여중
											</h5>
										
										<div style="display: block; text-align: center;">
											<a th:if="${memcheck == null } and ${#strings.equals(detailChall.challStatus, '시작 전')}" class="btn btn-primary mt-4 py-2 px-4"
											 id="applyBtn" style="margin: auto;">도전 신청하기</a>
											<a th:if="${memcheck !=null } and ${#strings.equals(detailChall.challStatus, '시작 전')}" class="btn btn-primary mt-4  py-2 px-4">참여중인 도전</a> 
											<a th:if="${#strings.equals(detailChall.challStatus, '진행 중')}" class="btn btn-primary mt-4  py-2 px-4">진행 중인 도전</a>
											<a th:if ="${#strings.equals(detailChall.challStatus, '종료')}" class="btn btn-primary mt-4 py-2 px-4" >종료된 도전</a>
										</div>
									</div>
								</div>
							</div>	
					</div>
				<!--대표사진 및 설명 + 신청 end-->

				<!--줄 -->
				<div class="d-flex flex-column text-left mb-3" style="width: 700px;">
					<div class="d-flex flex-column text-left mb-3">
						<p class="section-title pr-5"></p>
					</div>
					<!--한줄바 -->
					<div class="row">
						<div class="col-12 text-left mb-2">
							<ul class="list-inline mb-4" id="menu-filters">
								<li class="btn btn-outline-primary m-1 active" id="detailBtn">상세보기</li>
								<th:block th:if="${myInfo !=null }">
									<th:block th:if="${#strings.equals(detailChall.challStatus, '진행 중')} or ${#strings.equals(detailChall.challStatus, '종료')}">
										<li class="btn btn-outline-primary m-1" th:if="${memcheck !=null}" id="vldBtn">인증하기</li>
										<li class="btn btn-outline-primary m-1" th:if="${memcheck !=null }" id="resultBtn">도전 달성률</li>
									</th:block>
									<th:block th:if="${leaderInfo.userId == myInfo.userId}">
										<li class="btn btn-outline-primary m-1"  id="memBtn">회원관리</li>
										<li class="btn btn-outline-primary m-1" id="vldRptBtn">인증 신고 관리</li>
									</th:block>
								</th:block>
							</ul>
						</div>
					</div>

				</div>
				<!--도전정보시작-->
				<div class="mb-5" style="display: inline-block;">
					<!--여기는 상세정보 탭-->
					<div style="display: inline-block;width: 700px" id="challDetail">
							<!-- 상세보기 소제목 -->
							<h1 class="mb-3">도전 상세정보</h1>
							<!-- <div class="mb-5" id="detailC" style="display: inline-block; height: auto; overflow: hidden;"> -->
							<p><span th:text="${detailChall.challIntro}"></span></p>
							<div class="row" style="justify-content: center;">
								<div style="width: 300px; padding: 1px; display: inline-block; text-align: center; margin-right: 10px;">
									<img class="rounded" th:src="|/imgView/${challImg[1].mediaServerFile}|" alt="vldFail"
										style="width: 280px; height:200px ; object-fit: cover"  />
										<h5 class="m-1 mt-2">성공 사진 예시</h5>
								</div>
								<div style="width: 300px; padding: 1px; display: inline-block;  text-align: center; margin-left: 10px;">
									<img class="rounded" th:src="|/imgView/${challImg[2].mediaServerFile}|" alt="vldFail"
										style="width: 280px; height:200px ; object-fit: cover"  />
										<h5 class="m-1 mt-2">실패 사진 예시</h5>
								</div>
								<p><span th:text="${detailChall.vldMethod}"></span></p>
							</div>		
					</div>
					<!--상세정보 끝-->

				<!-- 여기부터 로그인 해야 보이는 부분.. -->
				<th:block th:if="${session.loginUser}">

					<!--인증하기 탭 눌렀을 때 활성화-->
					<div style="display: none;" id="challVld">
						<div style="width: 700px; text-align: center;">
							<!-- 첫 번째 Modal을 여는 클래스 -->
							<button th:if=" ${#strings.equals(detailChall.challStatus, '진행 중')}"  class="modalBtn btn btn-primary px-3" id="vldAddModal">인증하기</button>
							<button th:if=" ${#strings.equals(detailChall.challStatus, '종료')}" 
							 style="display: none;" class="modalBtn btn btn-primary px-3">이미 종료된 도전입니다.</button>
							<!-- 인증 구분 라벨 -->
							<div class="col-12 text-center mb-2">
								<ul class="list-inline mb-4 mt-4" id="myVldPage">
									<li class="btn btn-outline-primary m-1 active" id="allVldPage"> ALL </li>
									<li class="btn btn-outline-primary m-1" th:if="${session.loginUser}"
										th:value="${session.loginUser.userId}" id="onlyMyVldPage"> MY
									</li>
								</ul>
							</div>

							<!-- 두 번째 Modal을 여는 클래스 -->
							<!--   <h1 class="modalBtn">MODAL_2 버튼</h1> -->
							<div class="row portfolio-container modalBtn" id="vldImg"
								style="width: 700px; height: fit-content; margin: 0; justify-content: center;">
							</div>
							<nav class="blog-pagination justify-content-center d-flex pageBtn" id="vldPaging" >
							</nav>
							<nav class="blog-pagination justify-content-center d-flex pageBtn" id="myVldPaging">
							</nav>
						</div>
					</div>
					<!-- 인증탭 끝  -->

					<!--달성률 시작-->
					<div style="display: none;" id="challResult">
						<input type="hidden" id="resultCheck" value="false">
						<div style="width: 700px; display: flex;justify-content: center;">
							<div style="text-align: center;">
								<canvas id="myChart" style="width: 450px; height: 450px; "></canvas>
								<p>나의 달성률</p>
							</div>
							<div style="text-align: center;">
								<canvas id="memChart" style="width: 200px; height: 200px;"></canvas>
								<p>멤버 달성률</p>
							</div>
						</div>
						<div th:if="${#strings.equals(detailChall.challStatus, '종료')}" id="rsChallShow">
							<h3>chall_result 검색해서..</h3>
						</div>
					</div>
					<!--달성률 탭 끝-->


					<!--멤버리스트 탭-->
					<div style="display: none; width: 700px; text-align: center;" id="challMem" >
						<input type="hidden" id="challMemCheck" value="false">
						<div class="bg-light p-5 rounded mb-3" style="width: 500px; text-align: center; margin: auto;" id="waitMemList" 
							th:if="${#strings.equals(detailChall.challStatus, '시작 전')}">
							<h3 class="mb-3" style="text-align: center;">도전 대기 멤버 리스트</h3>
						</div>
						<div class="bg-light p-5 rounded mb-3" style="width: 500px; text-align: center; margin: auto;" id="nowMemList">
							<h3 class="mb-3" style="text-align: center;">참여 중인 멤버 리스트</h3>
						</div>
					</div>
					<!--멤버리스트 탭 끝-->

					<!-- 인증신고 관리..리더만 -->
					<div id="vldRpt">
						<input type="hidden" id="reportCheck" value="false">
						<div class="row portfolio-container" id="vldRptList">
						</div>
					</div>
					<!--인증신고 관리 끝  -->
				
				</th:block> 

				</div>
				<!-- 도전정보 라벨누르면왔다갔다 끝 -->

				<!-- 모달내용 부분 / 여기도 로그인해야 모달이용가능해서 if문 걸어야함-->
				<th:block th:if="${session.loginUser}">

				<!-- 첫 번째 Modal -->
				<div class="modal">
					<!-- 첫 번째 Modal의 내용 -->
					<div class="modal-content bg-light p-5" style="width:600px">
						<span class="close">X</span>
						<input type="hidden" id="vldCheck" value="false">
						<h2 class="mb-4">Validation GoGo</h2>
						<div id="image_preview">
							<!--이미지 미리보기-->
							<!--도전기간 / 횟수 / 참여자 수 -->
							<input id="challDur" name="challDur" type="hidden"
								th:value="${detailChall.challDuration}" />
							<input id="challFreq" name="challFreq" type="hidden" th:value="${detailChall.challFreq}" />
							<input id="nowMem" type="hidden" th:value="${detailChall.nowMem}" />
							<input id="maxMem" type="hidden" th:value="${detailChall.maxMem}" />
							<input id="challSt" type="hidden" th:value="${detailChall.challStatus}" />
							<form action="/own/chall/insertVldForm" method="post" id="insertChall"
								enctype="multipart/form-data">
								<input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
								<div class="form-group">
									<!--도전번호, 유저 아이디 히든 if를 걸면 해당 정보 가져오지 못하니 주의하기! -->
									<input id="challNo" name="challNo" type="hidden"
										th:value="${detailChall.challNo}" />
									<input id="userId" name="userId" type="hidden" th:if="${session.loginUser}"
										th:value="${session.loginUser.userId}" />
									<label for="name">NickName *</label>
									<input type="text" class="form-control" id="vldname" th:if="${memcheck !=null }"
										th:value="${myInfo.memNickname}" readonly />
								</div>
								<div class="form-group">
									<label for="name">Date *</label> <input type="text" class="form-control"
										id="vldname" th:value="${#calendars.format(#calendars.createNow(), 'yyyy-MM-dd')}"
											readonly />
								</div>
								<input name="uploadfile" type="file" id="btnAtt">
								<div id="att_zone" data-placeholder='사진을 첨부하세요'></div>
									<br>
									<div class="form-group mb-0">
										<!-- <button type="submit" class="btn btn-primary px-3" id="vldFormSubmit">등록</button> -->
										<input type="submit" value="등록하기" class="btn btn-primary px-3"
											id="vldFormSubmit" />
								</div>
							</form>
						</div>
					</div>
				</div>
 
				<!-- 두 번째 Modal -->
				<div class="modal">
					<!-- 두 번째 Modal의 내용 -->
					<div class="modal-content bg-light p-5" id="vldReport" style="padding:35px;width: 700px">
						<span class="close" style="text-align: right;">X</span>
						<div class="row">
							<input type="hidden" id="vldReportNo">
							<input type="hidden" id="vldReportId">
							<input type="hidden" id="vldNickName">
							<h2 style="margin-right: 15px;"></h2>
							<h4 class="mr-3" style="padding: 3px; float: right; " id="userRpt">
								<!-- 세 번째 Modal을 여는 클래스 -->
								<i class="modalBtn fas fa-bullhorn text-primary"></i>
							</h4>
							<button class="btn btn-primary m-0" id="delVld" style="float: right; margin-left: 10px;">인증삭제</button>
						</div>
						<img src="" style="width:500px ;height: 400px; margin: auto; object-fit: cover"/>
						<h3 style="text-align: right;"></h3>
						<input type="hidden" />
						<button class="btn btn-primary px-3" id="rptBtn">신고</button>
							<div style="display: none" id="reportArea">
								<textarea style="width:95%; margin:10px" id="rptReason"></textarea>
								<button class="btn btn-primary px-3" id="rptAddBtn" style="width: 150px; margin:auto">신고 접수하기</button>
							</div>
					</div>
				</div>
 
				<!-- 세 번째 Modal -->
				<div class="modal">
					<!-- 세 번째 Modal의 내용 -->
					<div class="modal-content bg-light p-5"  style="width:550px; height:670px;">
						<span class="close">X</span>
						<div id = "container" style="padding-bottom: 20px;">
							<h2 style="text-align: center; margin: 10px;margin-bottom: 30px;">회원 신고</h2>
							<form role="form"  autocomplete="off" style="width: 80%; margin: auto;"enctype="multipart/form-data" name="frm" id="frm">
							<input type="hidden" th:name="${_csrf.parameterName}"th:value="${_csrf.token}">
							<input type="hidden" th:if="${session.loginUser.userId}" th:value="${session.loginUser.userId}" id="reporter" name="reporter">
							<!-- <div class="input-form col-md-12 mx-auto"> -->
								<div class="form-group mb-4">
									<label for="dereporter">신고대상 *</label>
									<input type="hidden"  id="dereporter" name="dereporter" readonly />
									<input type="text" class="form-control" id="rptNickName" readonly />
								</div>
								<div class="form-group mb-4">
									<label for="reason">신고사유 *</label>
									<select class="form-control" id="reason" name="reason" style="height: 47px">
										<option selected>:: 신고사유를 선택해주세요 ::</option>
										<option value="욕설">욕설</option>
										<option value="광고">광고</option>
										<option value="부적절한 아이디">부적절한 아이디</option>
									</select>
								</div>
								<div class="form-group mb-4">
									<label for="name">Date *</label> <input type="text" class="form-control"
										id="vldname" th:value="${#calendars.format(#calendars.createNow(), 'yyyy-MM-dd')}"
											readonly />
								</div>
								<div class="form-group mb-5">
									<label for="code">신고 증거 사진첨부</label>
									<input  name="uploadfile" type="file" id="uploadfile" multiple="multiple">
								</div>
								<div style="text-align: center;">
									<button type="button" class="btn btn-primary px-3" style="width: 150px;" id="btnreporting">신고</button>                
								</div>
							</form>
						</div>
					</div>
				</div>   
				<!-- 세번째모달 전체모달 끝 -->
				<!-- 모달전체 이프문 끝 -->
				</th:block>
			</div> 
			<!-- 도전에 관련된것 ... 왼쪽부분 모두 -->

			<div class="col-lg-4 mt-5 mt-lg-0">
				<!-- 도전리더 프로필 -->
				<div class="d-flex flex-column text-center bg-primary rounded mb-5 py-5 px-4">
					<div th:if="${leaderInfo.memImage}">
						<p class="text-white">CHALLL LEADER</p>
							<!-- 도전리더 프로필 있는 경우-->
							<img th:src="|/imgView/${leaderInfo.memImage}|" class="img-fluid rounded-circle mx-auto mb-4"
								style="width: 200px; height:200px ; object-fit: cover" />
					</div>
					<h3 class="text-secondary mb-3" th:text="${leaderInfo.memNickname}"></h3>
					<p class="text-white m-0" th:text="${leaderInfo.memIntro}"></p>
				</div>

				<!-- Search Form -->
				<div class="mb-5">
					<form action="">
						<div class="input-group">
							<input type="text" class="form-control form-control-lg"
								placeholder="어떤 도전을 하시겠어요?" id="searchWord" />
							<div class="input-group-append" id="searchBtn">
								<span class="input-group-text bg-transparent text-primary"><i
									class="fa fa-search"></i></span>
							</div>
						</div>
					</form>
				</div>

				<!-- 새로운 도전 란..-->
				<div class="mb-5">
					<h2 class="mb-4">Recent Challenges</h2>
					<th:block th:each="nwch: ${newChall}">
						<div class="d-flex align-items-center bg-light shadow-sm rounded overflow-hidden mb-3 gotoNewChall">
							<img class="img-fluid"  th:src="|/imgView/${nwch.firstImage}|" style="width: 80px; height: 80px;  object-fit: cover" />
							<input type="hidden" th:value = "${nwch.challNo}" />
							<div class="pl-3">
								<h6 th:text="${nwch.challTitle}"></h6>
								<div class="d-flex">
									<small class="mr-3"><i class="fa fa-user text-primary"></i> [[${nwch.nowMem}]]명 참여중</small> 
									<small class="mr-3"><i class="fa fa-folder text-primary"></i> [[${nwch.challCategory}]]</small> 
								</div>
							</div>
						</div>
					</th:block>
				</div>

				<!-- Plain Text -->
				<div >
					<h2 class="mb-4"> 오늘의 운동 </h2>
					Aliquyam sed lorem stet diam dolor sed ut sit. Ut sanctus erat ea
					est aliquyam dolor et. Et no consetetur eos labore ea erat voluptua
					et. Et aliquyam dolore sed erat. Magna sanctus sed eos tempor rebum
					dolor, tempor takimata clita sit et elitr ut eirmod.
				</div>
			</div>
		</div>
	</div>
	<!-- Detail End -->

	<!-- Footer End -->

	<script>
    //토큰있어야 post가능~!
    /*<![CDATA[*/
    var header = '[[${_csrf.headerName}]]';
     var token = '[[${_csrf.token}]]';
       console.log(header);
       console.log(token);
     /*]]>*/
	//
	
	//----자주쓰는애들 정의 지금 1. 지금 상세보는 도전번호  2. 로그인한 회원아이디
	let challNo = $('#challNo').val();
	let userId = $('#userId').val();


	//아작스로 불러온거 날짜변형하기 ------------------------------------------------
	function leftPad(value) {
		if (value >= 10) {
			return value;
		}
		return `0${value}`;
	}

	function toStringByFormatting(source, delimiter = '-') {
		const year = source.getFullYear();
		const month = leftPad(source.getMonth() + 1);
		const day = leftPad(source.getDate());
		return [year, month, day].join(delimiter);
	}

	//검색하기
	$('#searchBtn').on('click', function(){
 			console.log("헐헐");
 			console.log($('#searchWord').val());
			let searchWord = $('#searchWord').val();
			console.log(searchWord);
			if(searchWord != ''){
				location.href = '/own/chall/searchChall?searchWord=' + searchWord
			} else if(searchWord == ''){
				alert('검색어를 입력해주세요!');
			}
 	});


	//--------------------------모달모달----------------------------------------------
		
	// Modal을 가져옵니다.
	var modals = document.getElementsByClassName("modal");
	// Modal을 띄우는 클래스 이름을 가져옵니다.
	var btns = document.getElementsByClassName("modalBtn");
	// Modal을 닫는 close 클래스를 가져옵니다.
	var spanes = document.getElementsByClassName("close");
	var funcs = [];
	 
	// Modal을 띄우고 닫는 클릭 이벤트를 정의한 함수
	function Modal(num) {
	  return function() {
	    // 해당 클래스의 내용을 클릭하면 Modal을 띄웁니다.
	    btns[num].onclick =  function() {
	        modals[num].style.display = "block";
	        console.log(num);
	    };
	 
	    // <span> 태그(X 버튼)를 클릭하면 Modal이 닫습니다.
	    spanes[num].onclick = function() {
	        modals[num].style.display = "none";
	    };
	  };
	}
	 
	// 원하는 Modal 수만큼 Modal 함수를 호출해서 funcs 함수에 정의합니다.
	for(var i = 0; i < btns.length; i++) {
	  funcs[i] = Modal(i);
	}
	 
	// 원하는 Modal 수만큼 funcs 함수를 호출합니다.
	for(var j = 0; j < btns.length; j++) {
	  funcs[j]();
	}
	 
	// Modal 영역 밖을 클릭하면 Modal을 닫습니다.
	window.onclick = function(event) {
	  if (event.target.className == "modal") {
	      event.target.style.display = "none";
	  }
	};
	
	//-------------------------- 모달모달 끝-----------------------------------------
	
	//좋아요 북마크 버튼 아작스
	$('.bmBtn').click(function(){
		console.log("북마크 버튼 클릭")
		let category = "Chall";
        $.ajax({
			url:'/own/likeAjax',
			method: 'post',
			data: JSON.stringify({userId: userId,
							      categoryNo: challNo,
							      category: category
								}),
			beforeSend : function(xhr){
						xhr.setRequestHeader(header, token);
			}, 
			contentType: "application/json",
			success:function(res){
				console.log(res);
				if(res == 'add'){
				alert("✔ 북마크 등록 완료 ✔")
				$('.bmBtn').removeAttr('style');					
				}
				else if(res == 'del'){
				alert("✔ 북마크 해제 완료 ✔")
				$('.bmBtn').attr('style', 'font-weight: 100')
				}
				else{
					alert('오운 로그인 후 이용해주세요.');
				}
			},
			error:function(err){
				console.log(err);
			}
		})
	})

	//인증삭제
	$('#delVld').on('click', function(e){
		console.log("인증삭제버튼");
		let vldNum = $(this).parent().children().eq(0).val();
		console.log($(this).parent().parent());
		console.log(vldNum)
		$.ajax({
			url:'/own/chall/vldDelete',
			method: 'post',
			data: { vldNo: vldNum },
			beforeSend : function(xhr){
						xhr.setRequestHeader(header, token);
			}, 
			success:function(res){
				alert("인증 삭제 완료.")
				let cutChallNo  = challNo.substr(4);
				location.href = '/own/chall/detailChall?challNo=' + cutChallNo;
				console.log(res);
			},
			error:function(err){
				console.log(err);
			}
		});
	});

	//회원신고 ----------------------------------------------------------------------------------
	$('#userRpt').on("click", function(e){
		console.log("회원신고");
		console.log($(this).parent().parent().find('input').eq(1).val());
		let reported = $(this).parent().parent().find('input').eq(1).val();
		let reportedNick = $(this).parent().parent().find('input').eq(2).val();
		let reporter = $('#reporter').val();
		console.log(reporter);
		console.log(reportedNick)
		$('#dereporter').val(reported);
		$('#rptNickName').val(reportedNick);
	});

	$('#btnreporting').on('click',function(){
		console.log("왜안되노..?")
		let formData = new FormData(document.frm);
		$.ajax({
			url: '/common/report',
			method: 'post',
			data : formData,
			cache: false,
				contentType: false,
				processData: false,
			beforeSend: function(xhr){
			xhr.setRequestHeader(header,token);
			},
			success:function(res){
				alert("신고 완료");
				console.log(res);
				//신고완료 시 새로고침.
				let cutChallNo  = challNo.substr(4);
				location.href = '/own/chall/detailChall?challNo=' + cutChallNo;
			},
			error:function(err){
				console.log(err);
				alert("오류 발생. 다시 시도해주세요.")	
			}
		});
	});

	//옆에 최근 생성된 도전클릭하면 이동
	$('.gotoNewChall').on("click", function(e){
		let nwCh = $(this).find('input').val();
		let cutChallNo  = nwCh.substr(4);
		console.log(nwCh);
		console.log(cutChallNo);
		location.href = '/own/chall/detailChall?challNo=' + cutChallNo;
	});

    //도전 신청으로 이동하기   --> 여유가되면 모달로 띄우기...^^;
    $('#applyBtn').on("click", function () {
		$.ajax({
			url:'/own/chall/applyCheck',
			method:'get',
			data:{ userId: userId,
				  challNo: challNo },
			success: function(res){
				console.log(res.memStatus);
				let memSt = res.memStatus
				if(userId != null && memSt == "대기") {
					alert('이미 도전신청 하였습니다. 승인을 기다려주세요.');
				} else if(userId != null && memSt == "거절"){
					alert('참여 거절된 도전입니다.');
				} else if(userId != null && memSt == null){
					location.href = '/own/chall/applyForm?challNo=' + challNo + '&&userId=' + userId;
				} else {
					alert('오운 로그인 후 이용해주세요.');
				}
			},
			error: function(err){
				console.log(err);
			}
		});
    });
    
    //메뉴 클릭 색깔 변경 이벤트
    $('#menu-filters li').click(function(){
    	$('#menu-filters li').removeClass('active');
    	$(this).addClass('active');
    });
    
	//도전삭제
	$('#delChall').click( function(){
		console.log("삭제");
		let nowChallMem = $('#nowMem').val();
		console.log(nowChallMem);
		if(nowChallMem == 0){
			console.log("삭제가능")
			$.ajax({
				url:'/own/chall/delChall',
				method:'post',
				data: {challNo:challNo},
				beforeSend : function(xhr){
							xhr.setRequestHeader(header, token);
				},
				success: function(res){
					console.log(res);
					if(res == 1){
						if(!confirm("도전을 삭제하시겠습니까?")){
							alert("도전삭제를 취소하였습니다.");
					} else{
						alert("도전 삭제. 도전 홈으로 이동합니다.");
						location.href = '/own/chall/home';
					}
				}
				},
				error: function(err){
					consol.log(err);
				}
			})
		} else{
			alert("참여하는 회원이 있어 삭제 불가능.");
		}
	});

    //-------------------------------상세보기-------------------------------------
      /* 상세보기 버튼 */
    $('#detailBtn').on("click", function () {
      $("#challDetail").css('display', 'inline-block');
      $("#challVld").css('display', 'none');
      $("#challResult").css('display', 'none');
      $("#challMem").css('display', 'none');
	  $("#vldRpt").css('display', 'none');
    })

    //--------------------------------인증하기-------------------------------------
    
    /*인증하기 버튼*/
    $('#vldBtn').on("click", function () {
      $("#challVld").css('display', "inline-block");
      $("#challDetail").css('display', 'none');
      $("#challResult").css('display', 'none');
      $("#challMem").css('display', 'none');
	  $("#vldRpt").css('display', 'none');

      let vldButton = $('#vldFormSubmit');
      console.log(challNo, userId);
      console.log($("#resultCheck").val());

	  //처음보여주는 아작스페이징!
      if($("#vldCheck").val() == "false"){
		//인증내역 페이징 아작스
		$.ajax({
          url: '/own/chall/vldPageListAjax',
          method: 'get',
		  data: {page:1,
				 pageUnit:4,
			     pageSize:5,
				 challNo: challNo,
				 vldStatus: "승인"},
          success: function(result){
            console.log(result);
            result.forEach( vld => {
              makeVldForm(vld)
            });
			let pagingName = 'vldPaging';
			makePaging(result, pagingName);
          },
          error: function(err){
            console.log(err);
          }
        });
        //인증횟수 확인하고 버튼 설정바꾸기
			$.ajax({
			url:'/own/chall/vldCheckAjax',
			method: 'post',
			data: JSON.stringify({ userId: userId,
								  challNo: challNo
								 }),
			beforeSend : function(xhr){
						xhr.setRequestHeader(header, token);
			}, 
			contentType: "application/json",
			success: function(result){
			if(result == 1){
				console.log('인증가능');
			} else if(result == 2){
				console.log("이미 오늘 인증 완료.")
				// $('#vldAddModal').removeClass('modalBtn').text('오늘 인증 완료.');
				$('#vldAddModal').attr('style', 'display:none');
				console.log($('#vldAddModal').parent());
				$('#vldAddModal').parent().prepend(('<p>오늘인증 완료하였습니다</p>'));
			} else if(result == 3 ){
				console.log("이번 주 인증완료.")
				$('#vldAddModal').attr('style', 'display:none').text('오늘 인증 완료.');
			} else{
				console.log("오류가 발생하였습니다.");
				alert('오류가 발생하였습니다.');
				$('#vldAddModal').attr('style', 'display:none').text('오늘 인증 완료.');
			}
			},
			error: function(err){
				console.log(err)
			}
		});
		$("#vldCheck").val("true");
		}
	}); //인증하기 첫버튼 끝

	    // 전체도전 아작스 번호이동.
		$('#vldPaging').on('click', '.pagePort', function(){
			$('#myVldPaging').empty();
		    //페이지번호 + 밴드식별번호
		    let page = $(this).attr('value');
			console.log(page)
		    console.log($(this).attr('value')); 
		    $.ajax({
		       url: '/own/chall/vldPageListAjax',
		       method: 'get',
			   data: {page:page, pageUnit:4, pageSize:5, challNo: challNo, vldStatus: "승인"}
		    }).then(result => {
		       console.log(result);
				//형태만들기 이미있는애들 없애준다.. -> 도전폼
				let Chall = $('#vldImg');
				$('#vldImg').empty();
				//다시 형태 붙이는애 만들어주기..
				result.forEach( vld => {
					makeVldForm(vld);
		       	})
				let pagingName = 'vldPaging';
				makePaging(result, pagingName);
				})
		});

		//첫 all페이지 불러오는 아작스 함수..
		function allVldAjax(){
			//페이징없애기..
			//$('#myVldPaging').empty();
			console.log("인증하기")
			//인증내역 페이징 아작스
			$.ajax({
			url: '/own/chall/vldPageListAjax',
			method: 'get',
			data:  {page:1,
					pageUnit:4,
					pageSize:5,
					challNo: challNo,
					vldStatus: "승인"},
			success: function(result){
				console.log(result);
				result.forEach( vld => {
				makeVldForm(vld)
				});
				let pagingName = 'vldPaging';
				makePaging(result, pagingName);
			},
			error: function(err){
				console.log(err);
			}
			})
		};

		//올 버튼 누를때 전체불러오는 아작스..
		$('#allVldPage').on('click', function(){
			console.log($('#myVldPaging'));
			//페이징지우고, 내용칸 지우기.
			$('#myVldPaging').empty();
			let Chall = $('#vldImg');
			$('#vldImg').empty();
			console.log("불러올까요? 아작스?");
			allVldAjax()
		});

		//인증버튼 메뉴 my/all 색깔 이벤트
		$('#myVldPage li').click(function(){
			$('#myVldPage li').removeClass('active');
			$(this).addClass('active');
    	})

	//-----------------------------------내도전페이징--------------------------------------------- 

		//점 어설프노..
		//마이 눌렀을때 첫 페이지   --자꾸 위에 정의해놓은 userId 가져가노...ㅠㅠ
		$('#onlyMyVldPage').on('click', function() {
			$('#vldPaging').empty();
		    //페이지번호 + 밴드식별번호
		    let myId = $(this).attr('value');
		    $.ajax({
				url: '/own/chall/vldPageListAjax',
				method: 'get',
				data: { page:1,
						pageUnit:4,
						pageSize:5,
						challNo: challNo,
						userId: myId},
				success: function(result){
					console.log(result);
					//처음불러온애들
					let Chall = $('#vldImg');
					$('#vldImg').empty();
					//다시 형태 붙이는애 만들어주기..
					result.forEach( vld => {
						makeVldForm(vld)
					});
					//페이징버튼...
					let pagingName = 'myVldPaging';
					makePaging(result, pagingName);
				},
				error: function(err){
					console.log(err);
				}
        	})    
		});

		// 내 인증 페이징 버튼 아작스.
		$('#myVldPaging').on('click', '.pagePort', function(){
		    //페이지번호 + 밴드식별번호
		    let page = $(this).attr('value');
			console.log(page)
		    console.log($(this).attr('value')); 
			console.log("유저 아이디..위에 선언한거...."+userId);
		    $.ajax({
		       url: '/own/chall/vldPageListAjax',
		       method: 'get',
			   data: { page: page,
					   pageUnit:4,
					   pageSize:5,
					   challNo: challNo,
					   userId: userId}
		    }).then(result => {
		       console.log(result);
				//형태만들기 이미있는애들 없애준다.. -> 도전폼
				let Chall = $('#vldImg');
				$('#vldImg').empty();
				//다시 형태 붙이는애 만들어주기..
				result.forEach(vld => {
					makeVldForm(vld);
		       	})
				let pagingName = 'myVldPaging';
				makePaging(result, pagingName);
				})
		    });


	//버튼 초기화
	/* 아작스 페이징 버튼 */
	function makePaging(result, pagingName){
			//버튼 다시초기화..비우기
			$(`#${pagingName}`).empty();
		    let pagingM = result[0].paging;
		    //시작 버튼
		    console.log(result[0]); //첫번째? 가져오기..?
		    let startpageTag = $('<ul class="pagination"  style="z-index: none" />');
		    $(`#${pagingName}`).append(startpageTag);
		    //이전 버튼만들기
		    if(pagingM.startPage>1){
			let pageBeforTag = `<li class="page-item">
                                <a class="page-link pagePort" aria-label="Previous" value=${pagingM.startPage-1}>
                                <span aria-hidden="true"> <-
								<span class="lnr lnr-chevron-left pagePort"></span></span></a>
                                </li>`
            startpageTag.append(pageBeforTag); 
		    }               
			//페이지목록..
		    for(let pg = pagingM.startPage; pg<=pagingM.endPage; pg++){
		            if(pg != pagingM.page){
		            	let pageTag = `<li class="page-item">
		                               <a class="page-link pagePort" value=${pg}>${pg}</a>
		                               </li>`
		                startpageTag.append(pageTag);
		            } else if(pg == pagingM.page ){
						 let pageTag =  `<li class="page-item active">
							<a class="page-link" >${pg}</a>
							</li>`
							startpageTag.append(pageTag);
					}
			}               
			//이후 버튼만들기
			if(pagingM.endPage<pagingM.lastPage){
						let pageAfterTag =`<li class="page-item">
							<a class="page-link pagePort" aria-label="Next" value=${pagingM.endPage+1}>
								<span aria-hidden="true"> ->
								<span class="lnr lnr-chevron-right"></span></span></a>
								</li>`
								startpageTag.append(pageAfterTag);
							}
							$(`#${pagingName}`).append(startpageTag);
		};


    /* 인증내역 아작스로읽어와서 사진폼으로 만들기 - 모달 X */
    function makeVldForm(vld){
      let userId = vld.userId;
      let mediaName = vld.mediaServerFile;
      let vldDate = toStringByFormatting(new Date(vld.vldDate));
      let vldNo = (vld.vldNo);
	  let vldNick = vld.userNick;

	  console.log("닉네임" + vldNick);

      let gridVld = `<div class="grid" style="padding: 5px" id=${vldNo} style="width:300px; height:320">
      					<div class="card card__one">
							<figure class="card__img">
								<img src=/imgView/${mediaName} style="width: 300px; height:200px ; object-fit: cover"/>
							</figure>
						<div class="card__desc vldno">
								<input class="vldNum" type="hidden" value=${vldNo}>
								<input class="vldNum" type="hidden" value=${userId}>
								<input class="vldNum" type="hidden" value=${vldNick}>
								<input class="vldNum" type="hidden" value=${vldDate}>
								<p>${vldNick}</p>
								<p>${vldDate}</p>
							</div>
						</div>
					</div>`		
	   $('#vldImg').append(gridVld);				
 	  /*   $('#vldImg').append(firstdiv.append(secondDiv.append(imgDiv, hTag))) */ 
    }
    
    //모달엑스누르면..초기화될 아이들..ㅋ
	$('.close').on('click',function(){
		$('#reportArea').attr('style', 'display:none');
		console.log($('#rptReason').val(""));
		$('#rptBtn').attr('style', 'display:block');
		console.log('왜안되나'); 
	});

	//모달 인증신고 인증 신고 -------------------------------------------------------------------------

	//인증이미지 클릭 시 모달 띄우기 오성공
	$('#vldImg').on('click','.grid',function(e){
		console.log(this); //이 창을.. 클릭하면 모달띄우기..
		//gird에 아이디값으로 식별번호 넣어둔거 읽어오기
		console.log("=========================");
		console.log($(this).attr('id'));
		let vldNo = $(this).attr('id'); //id에 넣어둔 인증식별번호
		let vldDtImg = $(this).find('img').attr('src'); //이미지 경로 읽어오기
		let vldDate = $(this).find('p').eq(1).text(); //p 안에 넣어둔 날짜
		let vldDtNo = $(this).find('input').eq(0).val(); //인풋 첫번째 -> 인증번호
		let vldDtId = $(this).find('input').eq(1).val(); // 인풋 두번째 -> 아이디
		let vldNick = $(this).find('input').eq(2).val(); // 인풋 세번째 -> 닉네임
		//각자 태그찾아서 값넣기~! 아이디값으로 넣어도되지않을까합니다..나중에...
		console.log(vldDtId);
		//두번째모달창안에 넣을 값들.
		$('#vldReport h2').text(vldNick);
		$('#vldReport img').attr('src', vldDtImg);
		$('#vldReport h3').text(vldDate);
		//첫번째 인풋 안에 id값주고 인증번호넣기
		$('#vldReportNo').val(vldNo);
		//두번째인풋창에 인증올린사람 아이디.
		$('#vldReportId').val(vldDtId);
		$('#vldNickName').val(vldNick);

		//내 인증이면 회원신고 버튼 안띄우기
		if(userId == vldDtId){
			$('#userRpt').attr('style', 'display:none');
			$('#delVld').attr('style', 'display:block');
		} else {
			$('#userRpt').attr('style', 'display:block');
			$('#delVld').attr('style', 'display:none');
		}

		//신고여부 확인.
		$.ajax({
	        url:'/own/chall/checkRptAjax?vldNo='+ vldNo + '&&reporter=' + userId,
	        method: 'get',
	        success: function(result){
	        		if(result > 0 || userId == vldDtId){
		          		console.log(result);
						$('#rptBtn').attr('style', 'display:none');
						//$('#rptBtn').replaceWith('<p>이미 신고한 인증입니다.</p>');
	        		}else {
						$('#rptBtn').attr('style', 'display:block');
	        			console.log('신고신청 가능 or s내 아이디 신고불가 ');
	        		}
	        },
	        error: function(err){
	          	console.log(err);
	        }
      	})		
	});

	//신고하기 누르면 신고폼 display block
	$('#rptBtn').on('click', function(e){
		console.log(e);
		console.log($(e).parent());
		// console.log(this.parent());
		console.log($(this).parent().find('input').val());
		$('#reportArea').attr('style', 'display:block');
	});

	//신고제출 버튼...
	$('#rptAddBtn').on('click', function(){
			console.log('신고제출 버튼');
			let vldRealNo = $(this).parent().parent().find('input').val();
			console.log(vldRealNo);
			// console.log($(this).parent().find('input').val());
			//신고사유
			console.log($('#rptReason').val());
			console.log("---------지금도전번호----" + challNo);
			console.log("---------지금로그인아이디 신고하는 사람----" + userId);
			let rptReason = $('#rptReason').val();
			let cutChallNo  = challNo.substr(4);
			console.log(cutChallNo);
	        $.ajax({
	            url:'/own/chall/addRptAjax',
	            method: 'post',
	            data: JSON.stringify({vldNo: vldRealNo,
	                                  reporter: userId,
	                                  reportReason: rptReason
	                                }),
	            beforeSend : function(xhr){
	                          xhr.setRequestHeader(header, token);
	            }, 
	            contentType: "application/json",
	            success: function(result){
					console.log(result);
	              if(result > 0){
	                console.log('신고 처리완.');
	                alert("신고가 완료되었습니다.");
	                location.href = '/own/chall/detailChall?challNo=' + cutChallNo
	              } else {
	                alert("오류가 발생하였습니다. 다시 시도해주세요.");
	              } 
	            },
	            error: function(err){
	              console.log(err)
	            }
	          })
		});
    
    //--------------------------------달성률-------------------------------------

     /*달성률 버튼*/
    $('#resultBtn').on("click", function () {
      $("#challResult").css("display", "inline-block");
      $("#challVld").css('display', 'none');
      $("#challDetail").css('display', 'none');
      $("#challMem").css('display', 'none')
	  $("#vldRpt").css('display', 'none');

	  let duration = $('#challDur').val();
	  let freq = $('#challFreq').val();
	  let challVldCount = duration * freq;
	  console.log("----도전 전체 인증횟수"+challVldCount);
	  //내 인증횟수 카운트로 가져오기 ㅎ
	  //현재 챌린지 회원들의 평균 인증 횟수..

	  $.ajax({
	        url:'/own/chall/vldCountAvgAjax?userId='+ userId + '&&challNo=' + challNo,
	        method: 'get',
	        success: function(result){
					console.log(userId);
	        		console.log(result);
					let myVld =  result.myVld;
					let nowMem = $('#nowMem').val();
					console.log("----도전 현재멤버"+nowMem);
					let memVld = (result.memVldAvg);
					console.log("----내가한 인증횟수"+myVld);
					console.log("----멤버 전체 횟수"+memVld);
					let memVldAvg=memVld/nowMem;
					console.log("----전체도전횟수/멤버수"+memVldAvg)
					var myChart = new Chart(context, {
						type: 'doughnut',
						data: {
							labels: [
								'나의 인증 성공 횟수',
								'남은 인증 횟수'
							  ],  
							  datasets: [{
								  label: '나의 인증',
								  data: [myVld, challVldCount - myVld],
								  backgroundColor: [
										'rgb(54, 162, 235)',
									    'rgba(23, 162, 184, 0.2)'
								  ],
								  hoverOffset: 4
							  }]
						  }
					});
					var memChart = new Chart(context2, {
						type: 'doughnut',
						data: {
							labels: [
								'멤버 평균 성공 횟수',
								'남은 인증 횟수'
							  ],  
							  datasets: [{
								  label: '멤버 평균 인증',
								  data: [memVldAvg, challVldCount - memVldAvg],
								  backgroundColor: [
										'rgb(54, 162, 235)',
									    'rgba(23, 162, 184, 0.2)'
								  ],
								  hoverOffset: 4
							  }]
						  }
					  });
					},
					error: function(err){
						console.log(err)
					}
				})
				
	  //달성률 구글차트
		var context = document.getElementById('myChart').getContext('2d');
		var context2 = document.getElementById('memChart').getContext('2d');

		let chStatus = $('#challSt').val();
		console.log(chStatus);
		if($("#resultCheck").val() == "false" && chStatus =="종료") {
			//달성결과 값 불러오기...
			$.ajax({
				url:'/own/chall/challResultAjax',
				method:'get',
				data: { challNo:challNo,
				    userId: userId },
					success:function(res){
						console.log(res.rewardPrice);
						console.log(res);
						if(res.rewardPrice === undefined){
							console.log("결과가없음. 아직 종료 노노");
						} else {
							console.log("결과가 있음.")
							let sucessPer = res.successRate * 100;
							let rewardsultTag = `<h4>달성률: ${sucessPer}%</h4>
								<ul>
								<li><h5>예상 도전 환급 금액: ${res.refundPrice}</h5></li>
								<li><h5>예상 도전 상금 금액: ${res.rewardPrice}</h5></li>
							</ul>`;
							$('#rsChallShow').append(rewardsultTag);
						}
					},
					error: function(err){
						console.log(err);
					}
				});
			}
			$("#resultCheck").val("true");
		})
    
    //-----------------------------리더만 신청회원보기-------------------------------------
   
    /*멤버 리스트 버튼 ul li 만들기*/ 
    $('#memBtn').on("click", function () {
      $("#challMem").css("display", "inline-block");
      $("#challDetail").css('display', 'none');
      $("#challVld").css('display', 'none');
      $("#challResult").css('display', 'none');
	  $("#vldRpt").css('display', 'none');
      console.log($("#challMemCheck").val());
      if($("#challMemCheck").val() == "false"){
		  let memWait = "대기";
		  let nowMem = "승인";
        $.ajax({
			//대기인원 검색.
			url: '/own/chall/challMemList?challNo=' + challNo + '&&memStatus=' + memWait,
          	method: 'get',
         	success: function (result) {
            console.log(result)
            let ul = $("<ul />")
            result.forEach(mem => {
              console.log("닉네임");
			  console.log(mem.memNick);
              ul.append($("<li />").text(mem.memNick)
              .append(  $("<input  />").attr('type', 'hidden').val(mem.userId),
						$("<button />").addClass('btn btn-primary').text('승인').attr('onclick', 'authChange(this)').attr('style', 'margin:10px'), 
			            $("<button />").addClass('btn').text('거절').attr('onclick', 'authChange(this)').attr('style', 'color:#17a2b8; background-color:fff;margin:5px; border-color:#17a2b8')));
            })
            $("#waitMemList").append(ul);
          },
          error: function (err) {
            console.log(err)
          }
        }),
		//현재회원
		$.ajax({
			url: '/own/chall/challMemList?challNo=' + challNo + '&&memStatus=' + nowMem,
			method: 'get',
			success: function (result) {
				console.log(result)
				let ul = $("<ul />")
				result.forEach(mem => {
				console.log(mem.userId, mem.memStatus)
				ul.append($("<li />").text(mem.memNick).attr('style', 'margin:20px'));
				})
				$("#nowMemList").append(ul);
			},
			error: function(err){
				console.log(err);
			}
		})
      }
      $("#challMemCheck").val("true");
    })
    
     /* 멤버 승인, 거절 버튼 -> 권한변경*/
    function authChange(e){
      console.log("이벤트 텍스트 "+$(e).text());
	  console.log("아이디 인풋");
	  console.log( $(e).parent().children().eq(0).val());
      let memNick = $(e).parent().text();
	  let memId = $(e).parent().children().eq(0).val();
      let memStatus = $(e).text();
	  let nowMem = $('#nowMem').val();
	  let maxMem = $('#maxMem').val();
	  console.log(memNick);
	  let memCutNick = memNick.slice(0, -4);
	  console.log(memCutNick);
	  if(nowMem >= maxMem){
		alert('최대인원을 초과하여 도전승인을 할 수 없습니다.');
	  } else{
		  $.ajax({
			  url: '/own/chall/challMemAuth',
			  method: 'post',
			  data: JSON.stringify({
				userId: memId,
				challNo: challNo,
				memStatus: memStatus
			}),
			beforeSend : function(xhr){
				xhr.setRequestHeader(header, token);
			}, 
			contentType: "application/json",
			success: function(result){
				console.log(result)
				alert(result);
				console.log($(e).parent().remove());
				$("#nowMemList ul").append($("<li />").text(memCutNick).attr('style', 'margin:20px'));
				let nowCnt = $('#nowMemCnt').text();
				let realNowCnt = Number(nowCnt) + 1;
				$('#nowMemCnt').text(realNowCnt);
			},
			error: function(err){
				console.log(err)
			}
		})
	}
    }
 
	//-----------------------------인증신고 관리 - 리더만 가능.--------------------------------

	$('#vldRptBtn').on('click', function(){
		$("#challVld").css('display', 'none');
      	$("#challDetail").css('display', 'none');
      	$("#challResult").css('display', 'none');
      	$("#challMem").css('display', 'none');
		$("#vldRpt").css('display', 'inline-block');

		if($("#vldCheck").val() == "false"){
			console.log("인증신고 관리하는 곳.");
			let reportState = "처리 중";
			$.ajax({
				url:'/own/chall/reportListAjax',
				method:'get',
				data: { challNo: challNo,
						reportState: reportState},
				success: function(res){
					console.log(res);
					res.forEach( result => {
						console.log(result);
						console.log("신고번호==" + result.vldNo);
						console.log(result.reportReason);
						makeRptVldForm(result);
					})
				},
				error: function(err){
					console.log(err);
				}
			})
		}
		$("#vldCheck").val("true");
	})

		function makeRptVldForm(vld){
		console.log(vld);
		let userId = vld.userId;
		let mediaName = vld.vldImg;
		let vldDate = (vld.vldDate);
		let vldNo = vld.vldNo;
		let reportRs = vld.reportReason;
		//신고당한사람
		let reported = vld.reported;
		let reporter = vld.reporter;
		console.log(mediaName);
		console.log(reported);
		let gridVld = `<div class="grid" style="padding: 10px" id=${vldNo}>
							<div class="card card__one" style="width: 330px; height:350px;" >
								<figure class="card__img">
									<img src=/imgView/${mediaName} 
									style="object-fit: cover"/>
								</figure>
							<div class="card__desc vldno">
									<input type="hidden" value=${vldNo}>
									<input type="hidden" value=${reporter}>
									<p>${reportRs}</p>
									<p>신고당한 사람: ${reported}</p>
									<button class="btn btn-primary" onclick="vldProcess(this)">신고 승인</button>
									<button class="btn btn-primary" onclick="vldProcess(this)">신고 반려</button>
								</div>
							</div>
						</div>`		
		$('#vldRptList').append(gridVld);				
		}

		function vldProcess(e){
			console.log($(e).parent().parent().parent());
			let girdRpt = $(e).parent().parent().parent();
			console.log($(e).text());
			console.log($(e).parent().find('input').eq(0).val());
			console.log($(e).parent().find('input').eq(1).val());
			let vldNo = $(e).parent().find('input').eq(0).val();
			let reporter = $(e).parent().find('input').eq(1).val();
			let rptAuth = $(e).text();
			console.log(vldNo);
			console.log(reporter);
			console.log(rptAuth);
				$.ajax({
				url: '/own/chall/reportProcess',
				method: 'post',
				data: JSON.stringify({ vldNo: vldNo,
									   reporter: reporter,
									   reportState: rptAuth
									}),
				beforeSend : function(xhr){
							xhr.setRequestHeader(header, token);
				}, 
				contentType: "application/json",
				success: function(result){
					alert(result);
					console.log(result)
					console.log($(e).parent().parent().parent().remove());
				},
				error: function(err){
					console.log(err)
				}
      		});
		};

	//----------------------------첨부파일 화면에 띄우기------------------------------------

      	/* att_zone : 이미지들이 들어갈 위치 id, btn : file tag id */
        imageView = function imageView(att_zone, btn){

            var attZone = document.getElementById(att_zone);
            var btnAtt = document.getElementById(btn)
            var sel_files = [];
            
            // 이미지와 체크 박스를 감싸고 있는 div 속성
            var div_style = 'display:inline-block;position:relative;'
                        + 'width:500px;height:auto;margin:5px;z-index:1';
            // 미리보기 이미지 속성
            var img_style = 'width:500px;height:300px; object-fit: cover ; z-index:none';
            // 이미지안에 표시되는 체크박스의 속성
            var chk_style = 'width: 30px;height: 30px;position: absolute;font-size: 18px;'
                        + 'right: 0px;bottom: 0px;z-index: 999;background-color: lightgray;color: white;border: none;opacity: 0.9;cursor: pointer;';
        
						
            btnAtt.onchange = function(e){
            var files = e.target.files;
            var fileArr = Array.prototype.slice.call(files)
            for(f of fileArr){
                imageLoader(f);
            }
            }  
        
            // 탐색기에서 드래그앤 드롭 사용
            attZone.addEventListener('dragenter', function(e){
            e.preventDefault();
            e.stopPropagation();
            }, false)
            
            attZone.addEventListener('dragover', function(e){
            e.preventDefault();
            e.stopPropagation();
            
            }, false)
        
            attZone.addEventListener('drop', function(e){
            var files = {};
            e.preventDefault();
            e.stopPropagation();
            var dt = e.dataTransfer;
            files = dt.files;
            for(f of files){
                imageLoader(f);
            }
            }, false)
            
            /*첨부된 이미리즐을 배열에 넣고 미리보기 */
            imageLoader = function(file){
            sel_files.push(file);
            var reader = new FileReader();
            reader.onload = function(ee){
                let img = document.createElement('img')
                img.setAttribute('style', img_style)
                img.src = ee.target.result;
                attZone.appendChild(makeDiv(img, file));
            }
            reader.readAsDataURL(file);
            }
            
            /*첨부된 파일이 있는 경우 checkbox와 함께 attZone에 추가할 div를 만들어 반환 */
            makeDiv = function(img, file){
            var div = document.createElement('div')
            div.setAttribute('style', div_style) 
            var btn = document.createElement('input')
            btn.setAttribute('type', 'button')
            btn.setAttribute('value', 'x')
            btn.setAttribute('delFile', file.name);
            btn.setAttribute('style', chk_style);
            btn.onclick = function(ev){
                var ele = ev.srcElement;
                var delFile = ele.getAttribute('delFile');
                for(var i=0 ;i<sel_files.length; i++){
                if(delFile== sel_files[i].name){
                    sel_files.splice(i, 1);      
                }
                }
                dt = new DataTransfer();
                for(f in sel_files) {
                var file = sel_files[f];
                dt.items.add(file);
                }
                btnAtt.files = dt.files;
                var p = ele.parentNode;
                attZone.removeChild(p)
            }
            div.appendChild(img)
            div.appendChild(btn)
            return div
            }
        }('att_zone', 'btnAtt')

  </script>
</body>
</div>
</html>