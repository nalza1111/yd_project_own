<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/default_layout}">
<head>
<!-- jquery -->
<script type="text/javascript" src="/band/js/jquery-3.2.1.js"></script>
<meta content="width=device-width, initial-scale=1.0" name="viewport" />
<meta content="Free HTML Templates" name="keywords" />
<!-- Favicon -->
<link href="/css/chall/img/favicon.ico" rel="icon" />
<!-- Google Web Fonts -->
<link rel="preconnect" href="https://fonts.gstatic.com" />
<link
	href="https://fonts.googleapis.com/css2?family=Handlee&family=Nunito&display=swap"
	rel="stylesheet" />
<!-- Font Awesome -->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
	rel="stylesheet" />
<!-- Flaticon Font -->
<link href="/css/chall/lib/flaticon/font/flaticon.css" rel="stylesheet" />
<!-- Libraries Stylesheet -->
<link href="/css/chall/lib/owlcarousel/assets/owl.carousel.min.css"
	rel="stylesheet" />
<link href="/css/chall/lib/lightbox/css/lightbox.min.css" rel="stylesheet" />
<!-- Customized Bootstrap Stylesheet -->
<link href="/css/chall/css/style.css" rel="stylesheet" />
<!-- JavaScript Libraries -->
<script
	src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
<script src="/css/chall/lib/easing/easing.min.js"></script>
<script src="/css/chall/lib/owlcarousel/owl.carousel.min.js"></script>
<script src="/chall/lib/isotope/isotope.pkgd.min.js"></script>
<script src="/css/chall/lib/lightbox/js/lightbox.min.js"></script>
<!-- Contact Javascript File -->
<script src="/css/chall/mail/jqBootstrapValidation.min.js"></script>
<script src="/css/chall/mail/contact.js"></script>
<!-- Template Javascript -->
<script src="/css/chall/js/main.js"></script>
<meta charset="utf-8">
<title>도전_신청 페이지</title>
</head>
<div layout:fragment="content">
	<body>
	<li>도전제목: <span th:text="${detailChall.challTitle}"></span>
	<li>도전대표 이미지 <img th:src="|/imgView/${challImg[0].mediaServerFile}|" alt="" />
	<li>도전카테고리: <span th:text="${detailChall.challCategory}"></span>
	<input id ="challNo" type="hidden" th:value="${detailChall.challNo}" />
	<input id ="challPrice" type="hidden" th:value="${detailChall.challPrice}" />	
		<div th:if="${session.loginUser}">
	안녕하세요 세션확인 
	<span th:text="${session.loginUser}"> ${session.loginUser} </span>
	<h1 th:text="${session.loginUser.userId}"></h1>
</div>
    <input id ="userId" type="hidden" th:value="${session.loginUser.userId}">
	<h3>도전 신청 페이지</h3>
	<!-- 상세보기 설명 살짝 -->
	<ul>
		<li>나의 도전다짐:</li>
		<li><textarea placeholder="나의 도전 다짐을 적어주세요." id="myIntro"></textarea></li>
		<li>나의 보유 예치금</li>
		<li>상금 및 환급 규정: </li>
		<li> <textarea readonly="readonly">100% 달성: 100% 환급 + 상금 / 85% 달성: 100% 환급 / 그 이하 달성 %에 따라 예치금 환급
			존나구구절절한 환급규정.어쩌고저쩌고~~~~ </textarea>
			<br /></li>
		<li><label><input type="checkbox" id="check1" name="agree" value="agree">동의 하시면 체크를 눌러주세요.</label>
		<li>환불 규칙: </li>
		<li><textarea readonly="readonly"> 3일전 환불 100% 시작 후 환불불가능</textarea></li>
		<li><label><input type="checkbox" id="check2"  name="agree" value="agree">동의 하시면 체크를 눌러주세요.</label>
	</ul>
		<button type="button" id="applyBtn">도전 신청하기</button>
	<script>
    /*<![CDATA[*/
    var header = '[[${_csrf.headerName}]]';
     var token = '[[${_csrf.token}]]';
       console.log(header);
       console.log(token);
     /*]]>*/

		$('#applyBtn').on("click", function(){
			let userId = $('#userId').val();
			let challNo =  $('#challNo').val();	
			let challPrice = $('#challPrice').val();
			let check1 = $('input:checkbox[id="check1"]').is(":checked")
			let check2 = $('input:checkbox[id="check2"]').is(":checked")
			console.log(check1)
			console.log(challNo, userId);
			if(check1 == true && check2 == true){
				$.ajax({
					url: '/own/chall/applyChall',
					method: 'post',
					data : JSON.stringify({userId: userId, 
										   challNo: challNo}),
					beforeSend : function(xhr){
							     xhr.setRequestHeader(header, token);
					},					   
 					contentType: "application/json",
 					success: function(res){
 						console.log(res)
						//성공시 예치금 - 시키기 
						$.ajax({
							url:'/own/chall/refundAmt',
							method:'post',
							data:JSON.stringify({userId:userId,
												price: challPrice,
												amtType: "도전참가"					
							}),
							beforeSend : function(xhr){
										xhr.setRequestHeader(header, token);
							},
							contentType:"application/json",
							success:function(res){
								location.href = '/own/chall/detailChall?challNo=' + challNo
							},
							error: function(err){
								console.log(err);
							}
						})
 					},
 					error: function(err){
 						console.log(err)
 					}
 				})
			} else{
				alert('모든 안내사항을 확인하고, 동의란에 체크 해 주세요.')
			}
		})
	</script>
</body>
</html>