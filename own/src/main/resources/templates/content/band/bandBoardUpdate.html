<html xmlns:th="http://www.thymeleaf.org"lang="ko">
<script src="/css/band/js/jquery-3.2.1.js"></script>
<script src="/css/band/js/json.min.js"></script>
 <!-- Bootstrap CSS -->
	<link rel="stylesheet" href="/css/band/vendors/linericon/style.css">
	<link rel="stylesheet" href="/css/band/css/font-awesome.min.css">
	<link rel="stylesheet" href="/css/band/vendors/owl-carousel/owl.carousel.min.css">
	<link rel="stylesheet" href="/css/band/vendors/bootstrap-datepicker/bootstrap-datetimepicker.min.css">
  	<link rel="stylesheet" href="/css/band/vendors/nice-select/css/nice-select.css">
	<link rel="stylesheet" href="/css/band/vendors/owl-carousel/owl.carousel.min.css">
	
	<!-- 서머노트를 위해 추가해야할 부분 -->
	<link rel="stylesheet" href="/css/band/editor/summernote-lite.css">
	<script src="/css/band/editor/summernote-lite.js"></script>
	<script src="/css/band/editor/lang/summernote-ko-KR.js"></script>
  <!--  --> 
<div id="template">    
<div style="flex-grow:3; width: 740px">
	<div>
		<article style="border: 1px solid #eeeeee;padding:30px; ">
		<form name="frm" id="frm">
			<input type="hidden" id="bandboardwriter" name="bandBoardWriter" th:value="${session.loginUser.userId}">
			[[${board.bandBoardDetailNo}]]
			<input type="hidden" id="bandBoardDetailNo" name="bandBoardDetailNo" th:value="${board.bandBoardDetailNo}">
			<h3>가치 글수정</h3>
			<select class="form-group" th:value="*{boardList}" id="bandBoardOptionNo" name="bandBoardOptionNo">
				<option disabled>::게시판을 선택해주세요::</option>
				<option th:if="${list.bandBoardLine}!='0'" th:each="list : ${boardList}" th:value="${list.bandBoardOptionNo}" th:text="${list.bandBoardName}" th:selected="${#strings.equals(list.bandBoardOptionNo, board.bandBoardOptionNo)}"></option>
			</select>
			<select class="form-group" name="bandRemarks" id="bandRemarks">
				<option value="">::말머리 선택::</option>
			</select>
			<div class="form-group">
				<input placeholder="타이틀" type="text" class="form-control" id="bandBoardTitle" name="bandBoardTitle" th:value="${board.bandBoardTitle}">
				<div class="form-group">
					<textarea id="summernote" name="bandBoardContent"></textarea>
				</div>
				<input placeholder="태그" type="text" class="form-control" id="tag" th:value="${board.bandBoardTag}">
				댓글 허용<input type="radio" class="form-group">
				<button type="button" id="updateBtn" class="btn btn-primary mb-2" style="background-color: #f3c300; color:white; float: right">수정</button>
			</div>
		</form>	
		</article>
	</div>
</div>
<script th:inline="javascript">
/*<![CDATA[*/
var header = '[[${_csrf.headerName}]]';
var token = '[[${_csrf.token}]]';
   console.log(header);
   console.log(token);
 /*]]>*/
$(function(){
	$(document).ready(function() {
		var content = '[[${board.bandBoardContent}]]';
		console.log(content);
		//썸머노트에 값넣기
	   $('#summernote').summernote('code', content);
		
		//여기 아래 부분
		$('#summernote').summernote({
			  height: 300,                 // 에디터 높이
			  minHeight: null,             // 최소 높이
			  maxHeight: null,             // 최대 높이
			  focus: true,                  // 에디터 로딩후 포커스를 맞출지 여부
			  lang: "ko-KR",					// 한글 설정
			  placeholder: '최대 2048자까지 쓸 수 있습니다',	//placeholder 설정
			  callbacks: {
		          onImageUpload : function(files, editor, welEditable){
		        	  //파일용량체크
		        	  for(var i = files.length -1; i >= 0; i--) {
		        		  if(files[i].siza > 1024*1024*50){
		        			  alert("이미지는 50MB이하만 첨부 가능합니다.");
		        			  return;
		        		  }
		        	  }
		                // 파일 업로드(다중업로드를 위해 반복문 사용)
		                for (var i = files.length - 1; i >= 0; i--) {
		                    uploadSummernoteImageFile(files[i], this);
		                    }
		                },
		                onPaste: function (e) {
							var clipboardData = e.originalEvent.clipboardData;
							if (clipboardData && clipboardData.items && clipboardData.items.length) {
								var item = clipboardData.items[0];
								if (item.kind === 'file' && item.type.indexOf('image/') !== -1) {
									e.preventDefault();
								}
							}
						}
		            } 
		});
		$('.summernote').summernote({
			  toolbar: [
				    // [groupName, [list of button]]
				    ['fontname', ['fontname']],
				    ['fontsize', ['fontsize']],
				    ['style', ['bold', 'italic', 'underline','strikethrough', 'clear']],
				    ['color', ['forecolor','color']],
				    ['table', ['table']],
				    ['para', ['ul', 'ol', 'paragraph']],
				    ['height', ['height']],
				    ['insert',['picture','link','video']],
				    ['view', ['fullscreen', 'help']]
				  ],
				fontNames: ['Arial', 'Arial Black', 'Comic Sans MS', 'Courier New','맑은 고딕','궁서','굴림체','굴림','돋움체','바탕체'],
				fontSizes: ['8','9','10','11','12','14','16','18','20','22','24','28','30','36','50','72']
		  });
		function uploadSummernoteImageFile(file, el) {
	        var data = new FormData();	
	        data.append("file",file);
	            $.ajax({
            	  url: '/own/band/bandGroup/bandBoardInsertImg',
	              type: "POST",
	              enctype: 'multipart/form-data',
	              data: data,
	              cache: false,
	              contentType : false,
	              processData : false,
	              beforeSend: function(xhr){
	                  xhr.setRequestHeader(header,token);
	                },
	              success : function(data) { //data는 url을 가져옴
	            	  		console.log(data);
	                        $(el).summernote('editor.insertImage','/imgView/'+data, data);
	                        
	                        //업로드되는 이미지의 이름을 담기..글 업로드 될 때 이미지DB식별키수정할거임
	                        let imgss = $('#bandBoardDetailNo').val();
	                        console.log(imgss);
	                        imgss += ('#'+data);
	                        $('#bandBoardDetailNo').val(imgss);
	                    },
	                    error : function(e) {
	                        console.log(e);
	                    }
	                });
           }
	});
	function jsonFn(jsonArray){
		console.log(jsonArray);
	}
	$("div.note-editable").on('drop',function(e){
        for(i=0; i< e.originalEvent.dataTransfer.files.length; i++){
        	uploadSummernoteImageFile(e.originalEvent.dataTransfer.files[i],$("#summernote")[0]);
        }
       e.preventDefault();
  })
})
</script>
<script>

$(function(){
	//글쓰기
		$('#updateBtn').on('click', function(){
		console.log($('#frm').serializeObject());
		//아작스
		/* $.ajax({
			url : '/own/band/bandGroup/bandBoardUpdate',
			method : 'put',
			data : JSON.stringify($('#frm').serializeObject()),
			dataType : 'json',
			contentType : "application/json",
			beforeSend: function(xhr){
              xhr.setRequestHeader(header,token);
            }
		}).then( res =>{
			console.log(res);
			if(res.bandBoardDetailNo!=null){
				console.log('글수정 완료')
				//$('#template').load("/own/band/bandGroup/bandBoardDetail?bandBoardDetailNo="+res.bandBoardDetailNo);
			} else {
				alert('글수정 실패');
			}
		})
	})  */
	/* let da = JSON.stringify($('#frm').serializeObject());
	function ipGetAddress(da) {
		  requestFetch = function() {
		    // perform the action..
		    xhr.setRequestHeader(header,token);
		    console.log('** beforeSend request fetch **');
		    return fetch.apply(this, arguments);
		  }

		  requestFetch('/own/band/bandGroup/bandBoardUpdate').then((response) => {
		    return response.json();
		  }).then((data) => {
		    console.log(data.ip);
		  });
	} */
//################
		//ipGetAddress('json') // return local ip address..
		//################		
		fetch('/own/band/bandGroup/bandBoardUpdate', {
	        method : 'put',
	        headers : {
	            'Content-Type' : 'application/json',
	            'X-CSRF-Token' : '82890a8a-4795-4bdf-a919-e6be093d1321'
	        },
	        body : JSON.stringify($('#frm').serializeObject())
	    })
	      .then(response => response.json())
	      .then(data => console.log(data));
	})
})
</script>
</div>